rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // HELPER FUNCTIONS
    // ============================================================

    // Any Firebase-authenticated user (anonymous or email/password)
    function isAuth() {
      return request.auth != null;
    }

    // Validate a required string with max length
    function isValidString(val, maxLen) {
      return val is string && val.size() > 0 && val.size() <= maxLen;
    }

    // Validate an optional string (may be absent or empty)
    function isOptionalString(val, maxLen) {
      return !(val is string) || val.size() <= maxLen;
    }

    // Limit document field count — prevent payload stuffing
    function docUnder(maxFields) {
      return request.resource.data.keys().size() <= maxFields;
    }

    // ============================================================
    // TIER 1: PUBLIC CREATE (website forms)
    //   - Anyone can CREATE with strict validation
    //   - Only authenticated users can read/update/delete
    // ============================================================

    match /websiteLeads/{doc} {
      allow create: if
        docUnder(20)
        && request.resource.data.keys().hasAll(['name', 'phone', 'status', 'source'])
        && isValidString(request.resource.data.name, 200)
        && isValidString(request.resource.data.phone, 50)
        && isValidString(request.resource.data.source, 100)
        && isValidString(request.resource.data.status, 50)
        && request.resource.data.status == 'new'
        && isOptionalString(request.resource.data.get('email', ''), 200)
        && isOptionalString(request.resource.data.get('address', ''), 500)
        && isOptionalString(request.resource.data.get('notes', ''), 2000)
        && isOptionalString(request.resource.data.get('fenceType', ''), 200);
      allow read, update, delete: if isAuth();
    }

    match /bookings/{doc} {
      allow create: if
        docUnder(15)
        && request.resource.data.keys().hasAll(['name', 'phone', 'date', 'time'])
        && isValidString(request.resource.data.name, 200)
        && isValidString(request.resource.data.phone, 50)
        && isValidString(request.resource.data.date, 30)
        && isValidString(request.resource.data.time, 30)
        && isOptionalString(request.resource.data.get('email', ''), 200)
        && isOptionalString(request.resource.data.get('address', ''), 500)
        && isOptionalString(request.resource.data.get('notes', ''), 2000);
      allow read, update, delete: if isAuth();
    }

    match /mail/{doc} {
      allow create: if
        docUnder(5)
        && request.resource.data.keys().hasAll(['to', 'message'])
        && request.resource.data.to is string
        && request.resource.data.to.size() <= 200
        && request.resource.data.message is map;
      allow read, update, delete: if isAuth();
    }

    match /securityLogs/{doc} {
      allow create: if
        docUnder(10)
        && request.resource.data.keys().hasAll(['action'])
        && isValidString(request.resource.data.action, 100);
      allow read: if isAuth();
      allow update, delete: if false;
    }

    // ============================================================
    // TIER 2: PUBLIC READ (website SSR + client reads)
    // ============================================================

    match /settings/{doc} {
      allow read: if true;
      allow write: if isAuth();
    }

    match /content/{doc} {
      allow read: if true;
      allow write: if isAuth();
    }

    match /siteContent/{doc} {
      allow read: if true;
      allow write: if isAuth();
    }

    match /pageContent/{doc} {
      allow read: if true;
      allow write: if isAuth();
    }

    match /gallery/{doc} {
      allow read: if true;
      allow write: if isAuth();
    }

    match /availableSlots/{doc} {
      allow read: if true;
      allow update: if
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['booked']);
      allow create, delete: if isAuth();
    }

    // ============================================================
    // TIER 3: AUTH-ONLY (all apps require anonymous or email auth)
    //   - Executive App, Crew App, Customer Portal all use
    //     signInAnonymously() at startup — invisible to user
    //   - Website Admin uses signInWithEmailAndPassword
    //   - Random internet traffic has NO auth → denied
    // ============================================================

    match /jobs/{doc} {
      allow read, write: if isAuth();
    }

    match /crewUsers/{doc} {
      allow read, write: if isAuth();
    }

    match /crewMembers/{doc} {
      allow read, write: if isAuth();
    }

    match /timeEntries/{doc} {
      allow read, write: if isAuth();
    }

    match /transactions/{doc} {
      allow read, write: if isAuth();
    }

    match /admin/{doc} {
      allow read, write: if isAuth();
    }

    match /leads/{doc} {
      allow read, write: if isAuth();
    }

    match /contracts/{doc} {
      allow read, write: if isAuth();
    }

    match /payments/{doc} {
      allow read, write: if isAuth();
    }

    match /invoices/{doc} {
      allow read, write: if isAuth();
    }

    match /signatures/{doc} {
      allow read, write: if isAuth();
    }

    match /crew/{doc} {
      allow read, write: if isAuth();
    }

    match /users/{doc} {
      allow read, write: if isAuth();
    }

    match /schedules/{doc} {
      allow read, write: if isAuth();
    }

    match /materials/{doc} {
      allow read, write: if isAuth();
    }

    match /inventory/{doc} {
      allow read, write: if isAuth();
    }

    match /customers/{doc} {
      allow read, write: if isAuth();
    }

    match /jobNotes/{doc} {
      allow read, write: if isAuth();
    }

    match /progress/{doc} {
      allow read, write: if isAuth();
    }

    match /messages/{doc} {
      allow read, write: if isAuth();
    }

    match /projectUpdates/{doc} {
      allow read, write: if isAuth();
    }

    // ============================================================
    // NO CATCH-ALL — unlisted collections denied by default
    // ============================================================
  }
}
