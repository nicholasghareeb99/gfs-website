---
const firebaseConfig = {
  apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY,
  authDomain: import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.PUBLIC_FIREBASE_APP_ID
};
---

<!-- Edit Mode: Only loads Firebase SDK when needed, activates for authenticated admins -->
<div id="edit-toolbar" style="display:none;">
  <div class="et-bar">
    <div class="et-left">
      <div class="et-logo">‚úèÔ∏è Edit Mode</div>
      <span class="et-page" id="et-page-name"></span>
    </div>
    <div class="et-center">
      <button id="et-toggle" class="et-btn et-btn-edit" title="Toggle editing">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        <span>Edit</span>
      </button>
      <button id="et-add-section" class="et-btn" title="Add content" style="display:none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
        <span>Add</span>
      </button>
    </div>
    <div class="et-right">
      <span id="et-changes" class="et-changes" style="display:none;">0 changes</span>
      <button id="et-save" class="et-btn et-btn-save" style="display:none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        Save Changes
      </button>
      <button id="et-discard" class="et-btn" style="display:none;">Discard</button>
      <button id="et-logout" class="et-btn et-btn-ghost">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Logout
      </button>
    </div>
  </div>
</div>

<!-- Login modal for Ctrl+Shift+E -->
<div id="et-login-modal" class="et-modal" style="display:none;">
  <div class="et-modal-content">
    <h3>üîê Admin Login</h3>
    <div style="margin-bottom: 16px;">
      <label style="display:block; margin-bottom: 6px; font-size: 14px; color: #6b7280;">Email</label>
      <input type="email" id="et-login-email" placeholder="admin@example.com" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" />
    </div>
    <div style="margin-bottom: 16px;">
      <label style="display:block; margin-bottom: 6px; font-size: 14px; color: #6b7280;">Password</label>
      <input type="password" id="et-login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" />
    </div>
    <div id="et-login-error" style="color: #ef4444; font-size: 13px; margin-bottom: 12px; display: none;"></div>
    <div class="et-modal-actions">
      <button id="et-login-cancel" class="et-btn">Cancel</button>
      <button id="et-login-submit" class="et-btn et-btn-save">Login</button>
    </div>
  </div>
</div>

<!-- Image upload modal -->
<div id="et-image-modal" class="et-modal" style="display:none;">
  <div class="et-modal-content">
    <h3>Replace Image</h3>
    <div class="et-upload-zone" id="et-upload-zone">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="40" height="40"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
      <p>Drag & drop an image or click to browse</p>
      <input type="file" id="et-file-input" accept="image/*" style="display:none;" />
    </div>
    <div class="et-upload-preview" id="et-upload-preview" style="display:none;">
      <img id="et-preview-img" src="" alt="Preview" />
    </div>
    <div class="et-modal-url">
      <label>Or enter image URL:</label>
      <input type="url" id="et-image-url" placeholder="https://..." />
    </div>
    <div class="et-modal-actions">
      <button id="et-image-cancel" class="et-btn">Cancel</button>
      <button id="et-image-apply" class="et-btn et-btn-save">Apply</button>
    </div>
  </div>
</div>

<style>
  #edit-toolbar {
    position: fixed; top: 0; left: 0; right: 0; z-index: 99999;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }
  .et-bar {
    display: flex; align-items: center; justify-content: space-between;
    background: #1a1a2e; color: white; padding: 8px 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.3); gap: 12px;
  }
  .et-left, .et-center, .et-right { display: flex; align-items: center; gap: 10px; }
  .et-logo { font-weight: 700; font-size: 14px; }
  .et-page { font-size: 12px; color: rgba(255,255,255,0.6); }
  .et-btn {
    display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px;
    border: 1px solid rgba(255,255,255,0.2); border-radius: 6px;
    background: transparent; color: white; font-size: 13px; cursor: pointer;
    transition: all 0.2s; white-space: nowrap;
  }
  .et-btn:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.4); }
  .et-btn-edit { background: #3b82f6; border-color: #3b82f6; }
  .et-btn-edit:hover { background: #2563eb; }
  .et-btn-edit.active { background: #ef4444; border-color: #ef4444; }
  .et-btn-edit.active:hover { background: #dc2626; }
  .et-btn-save { background: #10b981; border-color: #10b981; }
  .et-btn-save:hover { background: #059669; }
  .et-btn-ghost { border-color: transparent; }
  .et-changes { font-size: 12px; color: #fbbf24; font-weight: 600; }

  /* Edit mode active styles */
  body.edit-mode-active { padding-top: 48px !important; }
  body.edit-mode-active [data-editable] {
    outline: 2px dashed transparent; cursor: text; transition: outline 0.2s;
    min-height: 1em; position: relative;
  }
  body.edit-mode-active [data-editable]:hover { outline: 2px dashed #3b82f6; }
  body.edit-mode-active [data-editable]:focus { outline: 2px solid #3b82f6; background: rgba(59,130,246,0.05); }
  body.edit-mode-active [data-editable-image] { position: relative; cursor: pointer; }
  body.edit-mode-active [data-editable-image]::after {
    content: 'üì∑ Click to replace'; position: absolute; bottom: 8px; right: 8px;
    background: rgba(0,0,0,0.8); color: white; padding: 4px 10px; border-radius: 4px;
    font-size: 12px; opacity: 0; transition: opacity 0.2s; pointer-events: none;
  }
  body.edit-mode-active [data-editable-image]:hover::after { opacity: 1; }
  body.edit-mode-active [data-editable-image]:hover { outline: 2px dashed #f59e0b; }

  /* Sortable sections */
  body.edit-mode-active [data-sortable] { position: relative; }
  body.edit-mode-active [data-sortable-item] { position: relative; }
  body.edit-mode-active [data-sortable-item]:hover { outline: 2px dashed #8b5cf6; }
  .et-drag-handle {
    position: absolute; top: 4px; left: -32px; width: 24px; height: 24px;
    background: #8b5cf6; color: white; border-radius: 4px; border: none;
    cursor: grab; display: none; align-items: center; justify-content: center; z-index: 10;
  }
  body.edit-mode-active [data-sortable-item]:hover .et-drag-handle { display: flex; }
  .et-item-controls {
    position: absolute; top: 4px; right: 4px; display: none; gap: 4px; z-index: 10;
  }
  body.edit-mode-active [data-sortable-item]:hover .et-item-controls { display: flex; }
  .et-item-btn {
    width: 28px; height: 28px; border-radius: 4px; border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center; font-size: 14px;
  }
  .et-item-btn-del { background: #ef4444; color: white; }
  .et-item-btn-dup { background: #3b82f6; color: white; }

  /* Modal */
  .et-modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100000;
    display: flex; align-items: center; justify-content: center; padding: 20px;
  }
  .et-modal-content {
    background: white; border-radius: 12px; padding: 32px;
    max-width: 500px; width: 100%; color: #1a1a2e;
  }
  .et-modal-content h3 { margin: 0 0 20px; }
  .et-upload-zone {
    border: 2px dashed #d1d5db; border-radius: 8px; padding: 40px;
    text-align: center; cursor: pointer; transition: all 0.2s; color: #6b7280;
  }
  .et-upload-zone:hover { border-color: #3b82f6; background: #f0f9ff; }
  .et-upload-zone p { margin: 12px 0 0; }
  .et-upload-preview { margin: 16px 0; text-align: center; }
  .et-upload-preview img { max-width: 100%; max-height: 200px; border-radius: 8px; }
  .et-modal-url { margin: 16px 0; }
  .et-modal-url label { display: block; margin-bottom: 6px; font-size: 14px; color: #6b7280; }
  .et-modal-url input {
    width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;
  }
  .et-modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
  .et-modal-actions .et-btn { color: #1a1a2e; border-color: #d1d5db; }
  .et-modal-actions .et-btn-save { color: white; }

  @media (max-width: 768px) {
    .et-bar { flex-wrap: wrap; padding: 6px 10px; }
    .et-left .et-page { display: none; }
    .et-btn span:not(:only-child) { display: none; }
  }
</style>

<script is:inline define:vars={{ firebaseConfig }}>
(function() {
  const FB_CFG = firebaseConfig;
  const hasFirebaseConfig = FB_CFG && FB_CFG.projectId && FB_CFG.apiKey;
  let auth, db, storage, user = null;
  let editActive = false;
  let changes = new Map();
  let originalContent = new Map();
  let firebaseLoaded = false;
  let firebaseLoading = false;

  // =============================================
  // 0. Ctrl+Shift+E keyboard shortcut
  // =============================================
  document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'E' || e.key === 'e')) {
      e.preventDefault();
      handleEditShortcut();
    }
  });

  async function handleEditShortcut() {
    // Check if Firebase is configured
    if (!hasFirebaseConfig) {
      alert('Edit Mode requires Firebase configuration.\n\nSet these environment variables on Netlify:\n‚Ä¢ PUBLIC_FIREBASE_API_KEY\n‚Ä¢ PUBLIC_FIREBASE_AUTH_DOMAIN\n‚Ä¢ PUBLIC_FIREBASE_PROJECT_ID\n‚Ä¢ PUBLIC_FIREBASE_STORAGE_BUCKET\n‚Ä¢ PUBLIC_FIREBASE_MESSAGING_SENDER_ID\n‚Ä¢ PUBLIC_FIREBASE_APP_ID\n\nGet these from Firebase Console ‚Üí Project Settings ‚Üí Web App.');
      return;
    }

    // If toolbar is already visible and user is logged in, toggle edit mode
    if (user && document.getElementById('edit-toolbar').style.display !== 'none') {
      if (editActive) {
        deactivateEditing();
      } else {
        activateEditing();
      }
      return;
    }

    // If Firebase not loaded yet, load it
    if (!firebaseLoaded && !firebaseLoading) {
      firebaseLoading = true;
      try {
        await loadFirebaseSDK();
        firebaseLoaded = true;
        firebaseLoading = false;
      } catch (err) {
        console.error('Failed to load Firebase:', err);
        firebaseLoading = false;
        return;
      }
    }

    // Wait for loading to finish if in progress
    if (firebaseLoading) {
      await new Promise(resolve => {
        const check = setInterval(() => {
          if (!firebaseLoading) { clearInterval(check); resolve(); }
        }, 100);
      });
    }

    // If user is already authenticated, show toolbar
    if (user) {
      showToolbar();
      activateEditing();
      return;
    }

    // Show login modal
    showLoginModal();
  }

  function showLoginModal() {
    const modal = document.getElementById('et-login-modal');
    const emailInput = document.getElementById('et-login-email');
    const passInput = document.getElementById('et-login-password');
    const errorDiv = document.getElementById('et-login-error');
    const cancelBtn = document.getElementById('et-login-cancel');
    const submitBtn = document.getElementById('et-login-submit');

    modal.style.display = 'flex';
    errorDiv.style.display = 'none';
    emailInput.value = '';
    passInput.value = '';
    emailInput.focus();

    cancelBtn.onclick = () => { modal.style.display = 'none'; };

    // Allow Enter key to submit
    const handleEnter = (e) => {
      if (e.key === 'Enter') doLogin();
    };
    emailInput.addEventListener('keydown', handleEnter);
    passInput.addEventListener('keydown', handleEnter);

    submitBtn.onclick = doLogin;

    async function doLogin() {
      const email = emailInput.value.trim();
      const pass = passInput.value;
      if (!email || !pass) {
        errorDiv.textContent = 'Please enter email and password.';
        errorDiv.style.display = 'block';
        return;
      }

      submitBtn.innerHTML = '‚è≥ Logging in...';
      submitBtn.disabled = true;
      errorDiv.style.display = 'none';

      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, pass);
        user = userCredential.user;
        modal.style.display = 'none';
        // Set cookie for future visits
        document.cookie = 'gfs_admin=1;path=/;max-age=86400;SameSite=Strict;Secure';
        // Set up auth listener for future state changes
        auth.onAuthStateChanged(u => {
          user = u;
          if (u) {
            document.cookie = 'gfs_admin=1;path=/;max-age=86400;SameSite=Strict;Secure';
            showToolbar();
          } else {
            document.cookie = 'gfs_admin=;path=/;max-age=0;SameSite=Strict;Secure';
            hideToolbar();
          }
        });
        // Show toolbar immediately
        showToolbar();
        activateEditing();
      } catch (err) {
        let msg = 'Login failed.';
        if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') {
          msg = 'Invalid email or password.';
        } else if (err.code === 'auth/too-many-requests') {
          msg = 'Too many attempts. Try again later.';
        }
        errorDiv.textContent = msg;
        errorDiv.style.display = 'block';
      }

      submitBtn.innerHTML = 'Login';
      submitBtn.disabled = false;

      // Clean up enter key listeners
      emailInput.removeEventListener('keydown', handleEnter);
      passInput.removeEventListener('keydown', handleEnter);
    }
  }

  // =============================================
  // 1. Check auth state ‚Äî load SDK if cookie hint exists AND config is available
  // =============================================
  if (hasFirebaseConfig && (document.cookie.includes('gfs_admin=1') || window.location.pathname.startsWith('/admin'))) {
    loadFirebaseAndInit();
  }

  async function loadFirebaseSDK() {
    if (!hasFirebaseConfig) {
      throw new Error('Firebase configuration missing. Set environment variables on Netlify.');
    }
    await loadScript('https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js');
    await loadScript('https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js');
    await loadScript('https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js');
    await loadScript('https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js');

    if (!firebase.apps.length) firebase.initializeApp(FB_CFG);
    auth = firebase.auth();
    db = firebase.firestore();
    storage = firebase.storage();
  }

  async function loadFirebaseAndInit() {
    if (!hasFirebaseConfig) return;
    firebaseLoading = true;
    try {
      await loadFirebaseSDK();
      firebaseLoaded = true;
    } catch (err) {
      console.error('Failed to load Firebase:', err);
    }
    firebaseLoading = false;

    auth.onAuthStateChanged(u => {
      user = u;
      if (u) {
        document.cookie = 'gfs_admin=1;path=/;max-age=86400;SameSite=Strict;Secure';
        showToolbar();
      } else {
        document.cookie = 'gfs_admin=;path=/;max-age=0;SameSite=Strict;Secure';
        hideToolbar();
      }
    });
  }

  function loadScript(src) {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) { resolve(); return; }
      const s = document.createElement('script');
      s.src = src; s.onload = resolve; s.onerror = reject;
      document.head.appendChild(s);
    });
  }

  // =============================================
  // 2. Toolbar controls + Content override loader
  // =============================================

  // Load saved page content overrides from Firestore (for admins with Firebase loaded)
  async function loadPageOverrides() {
    if (!db) return;
    try {
      const pagePath = getPageDocPath(); // e.g., 'pageEdits/fences-cedar'
      const snap = await db.doc(pagePath).get();
      if (snap.exists) {
        const data = snap.data();
        Object.entries(data).forEach(([key, value]) => {
          if (!value || key === 'updatedAt' || key === 'updatedBy') return;
          const el = document.querySelector(`[data-editable="${key}"]`);
          if (el) {
            if (el.dataset.editType === 'html' || el.dataset.editType === 'richtext') el.innerHTML = value;
            else el.textContent = value;
          }
          const imgEl = document.querySelector(`[data-editable-image="${key}"]`);
          if (imgEl && value) {
            const img = imgEl.querySelector('img') || imgEl;
            if (img.tagName === 'IMG') img.src = value;
            else imgEl.style.backgroundImage = `url(${value})`;
          }
        });
        console.log('[EditMode] Applied', Object.keys(data).length, 'overrides for', pagePath);
      }
    } catch(e) { console.warn('[EditMode] Page overrides:', e.message); }
  }
  function showToolbar() {
    const toolbar = document.getElementById('edit-toolbar');
    if (toolbar) {
      toolbar.style.display = 'block';
      document.body.style.paddingTop = '48px';
      document.getElementById('et-page-name').textContent = document.title.split('|')[0].trim();
      bindToolbarEvents();
    }
  }

  function hideToolbar() {
    const toolbar = document.getElementById('edit-toolbar');
    if (toolbar) toolbar.style.display = 'none';
    document.body.style.paddingTop = '';
    deactivateEditing();
  }

  function bindToolbarEvents() {
    const toggleBtn = document.getElementById('et-toggle');
    const saveBtn = document.getElementById('et-save');
    const discardBtn = document.getElementById('et-discard');
    const logoutBtn = document.getElementById('et-logout');

    toggleBtn.onclick = () => { if (editActive) deactivateEditing(); else activateEditing(); };
    saveBtn.onclick = saveChanges;
    discardBtn.onclick = discardChanges;
    logoutBtn.onclick = () => { if (auth) auth.signOut(); window.location.href = '/'; };
  }

  // =============================================
  // 3. Activate / Deactivate editing
  // =============================================
  function activateEditing() {
    editActive = true;
    document.body.classList.add('edit-mode-active');
    const btn = document.getElementById('et-toggle');
    btn.classList.add('active');
    btn.querySelector('span').textContent = 'Stop Editing';
    document.getElementById('et-add-section').style.display = 'inline-flex';

    document.querySelectorAll('[data-editable]').forEach(el => {
      el.contentEditable = 'true';
      originalContent.set(el, el.innerHTML);
      el.addEventListener('input', onContentEdit);
      el.addEventListener('blur', onContentBlur);
    });

    document.querySelectorAll('[data-editable-image]').forEach(el => {
      el._editClick = () => openImageModal(el);
      el.addEventListener('click', el._editClick);
    });

    document.querySelectorAll('[data-sortable-item]').forEach(el => {
      if (!el.querySelector('.et-item-controls')) {
        const controls = document.createElement('div');
        controls.className = 'et-item-controls';
        controls.innerHTML = '<button class="et-item-btn et-item-btn-del" title="Delete">‚úï</button>';
        controls.querySelector('.et-item-btn-del').onclick = (e) => { e.stopPropagation(); deleteItem(el); };
        el.style.position = 'relative';
        el.appendChild(controls);
      }
    });
  }

  function deactivateEditing() {
    editActive = false;
    document.body.classList.remove('edit-mode-active');
    const btn = document.getElementById('et-toggle');
    if (btn) { btn.classList.remove('active'); btn.querySelector('span').textContent = 'Edit'; }
    const addBtn = document.getElementById('et-add-section');
    if (addBtn) addBtn.style.display = 'none';

    document.querySelectorAll('[data-editable]').forEach(el => {
      el.contentEditable = 'false';
      el.removeEventListener('input', onContentEdit);
      el.removeEventListener('blur', onContentBlur);
    });

    document.querySelectorAll('[data-editable-image]').forEach(el => {
      if (el._editClick) { el.removeEventListener('click', el._editClick); delete el._editClick; }
    });
  }

  // =============================================
  // 4. Track changes
  // =============================================
  function onContentEdit(e) { const el = e.target.closest('[data-editable]'); if (el) trackChange(el); }
  function onContentBlur(e) { const el = e.target.closest('[data-editable]'); if (el) trackChange(el); }

  // Derive a page-level Firestore doc path from the URL
  // Uses collection 'pageEdits', doc = page slug
  function getPageDocPath() {
    const path = window.location.pathname.replace(/^\/|\/$/g, '') || 'home';
    return 'pageEdits/' + path.replace(/\//g, '-');
  }

  function trackChange(el) {
    // Use explicit doc/field if set, otherwise default to page doc + editable name
    const docPath = el.dataset.editDoc || getPageDocPath();
    const field = el.dataset.editField || el.getAttribute('data-editable');
    if (!docPath || !field) return;
    if (!changes.has(docPath)) changes.set(docPath, {});
    const isHTML = el.dataset.editType === 'html' || el.dataset.editType === 'richtext';
    changes.get(docPath)[field] = isHTML ? el.innerHTML : el.textContent.trim();
    updateChangesCount();
  }

  function trackImageChange(el, newSrc) {
    const docPath = el.dataset.editDoc || getPageDocPath();
    const field = el.dataset.editField || el.dataset.editImageField || el.getAttribute('data-editable-image');
    if (!docPath || !field) return;
    if (!changes.has(docPath)) changes.set(docPath, {});
    changes.get(docPath)[field] = newSrc;
    updateChangesCount();
  }

  function updateChangesCount() {
    let count = 0;
    changes.forEach(fields => { count += Object.keys(fields).length; });
    const el = document.getElementById('et-changes');
    const saveBtn = document.getElementById('et-save');
    const discardBtn = document.getElementById('et-discard');
    if (count > 0) {
      el.style.display = 'inline'; el.textContent = count + ' change' + (count !== 1 ? 's' : '');
      saveBtn.style.display = 'inline-flex'; discardBtn.style.display = 'inline-flex';
    } else {
      el.style.display = 'none'; saveBtn.style.display = 'none'; discardBtn.style.display = 'none';
    }
  }

  // =============================================
  // 5. Save changes to Firestore
  // =============================================
  async function saveChanges() {
    if (!db || changes.size === 0) return;
    const saveBtn = document.getElementById('et-save');
    saveBtn.innerHTML = '‚è≥ Saving...'; saveBtn.disabled = true;

    try {
      const batch = db.batch();
      changes.forEach((fields, docPath) => {
        const ref = db.doc(docPath);
        const update = {};
        for (const [field, value] of Object.entries(fields)) { update[field] = value; }
        batch.set(ref, update, { merge: true });
      });
      await batch.commit();
      changes.clear();
      updateChangesCount();

      saveBtn.innerHTML = '‚úÖ Saved!';
      setTimeout(() => {
        saveBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save Changes';
        saveBtn.disabled = false;
      }, 2000);

      document.querySelectorAll('[data-editable]').forEach(el => { originalContent.set(el, el.innerHTML); });
    } catch (e) {
      console.error('Save error:', e);
      saveBtn.innerHTML = '‚ùå Error ‚Äî try again'; saveBtn.disabled = false;
      alert('Save failed: ' + e.message);
    }
  }

  function discardChanges() {
    if (!confirm('Discard all unsaved changes?')) return;
    originalContent.forEach((html, el) => { el.innerHTML = html; });
    changes.clear();
    updateChangesCount();
  }

  // =============================================
  // 6. Image editing
  // =============================================
  let currentImageEl = null;

  function openImageModal(el) {
    currentImageEl = el;
    const modal = document.getElementById('et-image-modal');
    modal.style.display = 'flex';
    document.getElementById('et-image-url').value = '';
    document.getElementById('et-upload-preview').style.display = 'none';
    document.getElementById('et-upload-zone').onclick = () => document.getElementById('et-file-input').click();
    document.getElementById('et-file-input').onchange = handleFileSelect;
    document.getElementById('et-image-cancel').onclick = () => { modal.style.display = 'none'; currentImageEl = null; };
    document.getElementById('et-image-apply').onclick = applyImage;
  }

  function handleFileSelect(e) {
    const file = e.target.files[0];
    if (!file) return;
    if (!file.type.match(/^image\/(jpeg|png|webp|gif|svg\+xml)$/)) { alert('Only image files allowed'); e.target.value = ''; return; }
    if (file.size > 5 * 1024 * 1024) { alert('Image must be under 5MB'); e.target.value = ''; return; }
    const reader = new FileReader();
    reader.onload = (ev) => {
      document.getElementById('et-preview-img').src = ev.target.result;
      document.getElementById('et-upload-preview').style.display = 'block';
    };
    reader.readAsDataURL(file);
  }

  async function applyImage() {
    if (!currentImageEl) return;
    const urlInput = document.getElementById('et-image-url');
    const fileInput = document.getElementById('et-file-input');
    let newSrc = '';

    if (fileInput.files[0] && storage) {
      const file = fileInput.files[0];
      if (file.size > 5 * 1024 * 1024) { alert('Image must be under 5MB'); return; }
      if (!file.type.startsWith('image/')) { alert('Only image files allowed'); return; }
      const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
      const path = `website-images/${Date.now()}-${safeName}`;
      const applyBtn = document.getElementById('et-image-apply');
      applyBtn.innerHTML = '‚è≥ Uploading...'; applyBtn.disabled = true;
      try {
        const ref = storage.ref(path);
        await ref.put(file);
        newSrc = await ref.getDownloadURL();
      } catch (e) {
        alert('Upload failed: ' + e.message);
        applyBtn.innerHTML = 'Apply'; applyBtn.disabled = false; return;
      }
      applyBtn.innerHTML = 'Apply'; applyBtn.disabled = false;
    } else if (urlInput.value.trim()) {
      newSrc = urlInput.value.trim();
    }

    if (newSrc) {
      if (currentImageEl.tagName === 'IMG') { currentImageEl.src = newSrc; }
      else { currentImageEl.style.backgroundImage = `url(${newSrc})`; }
      trackImageChange(currentImageEl, newSrc);
    }

    document.getElementById('et-image-modal').style.display = 'none';
    currentImageEl = null; fileInput.value = '';
  }

  // =============================================
  // 7. Delete sortable items
  // =============================================
  function deleteItem(el) {
    if (!confirm('Delete this item?')) return;
    const doc = el.dataset.editDoc;
    const index = el.dataset.editIndex;
    if (doc && index !== undefined) {
      if (!changes.has(doc)) changes.set(doc, {});
      const existing = changes.get(doc);
      if (!existing._deletions) existing._deletions = [];
      existing._deletions.push(parseInt(index));
    }
    el.style.transition = 'all 0.3s'; el.style.opacity = '0'; el.style.transform = 'scale(0.9)';
    setTimeout(() => el.remove(), 300);
    updateChangesCount();
  }

  // =============================================
  // 8. Drag & drop upload on upload zone
  // =============================================
  document.addEventListener('DOMContentLoaded', () => {
    const zone = document.getElementById('et-upload-zone');
    if (zone) {
      zone.addEventListener('dragover', e => { e.preventDefault(); zone.style.borderColor = '#3b82f6'; });
      zone.addEventListener('dragleave', () => { zone.style.borderColor = '#d1d5db'; });
      zone.addEventListener('drop', e => {
        e.preventDefault(); zone.style.borderColor = '#d1d5db';
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
          if (file.size > 5 * 1024 * 1024) { alert('Image must be under 5MB'); return; }
          const dt = new DataTransfer(); dt.items.add(file);
          document.getElementById('et-file-input').files = dt.files;
          const reader = new FileReader();
          reader.onload = ev => {
            document.getElementById('et-preview-img').src = ev.target.result;
            document.getElementById('et-upload-preview').style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });
    }
  });

  // Expose for login page
  window.GFS_EditMode = { loadFirebaseAndInit };
})();
</script>
