---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getSiteSettings } from '../../../lib/firestore.js';
const site = await getSiteSettings();
const firebaseConfig = {
  apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY,
  authDomain: import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.PUBLIC_FIREBASE_APP_ID
};
const mapsApiKey = import.meta.env.PUBLIC_GOOGLE_MAPS_KEY;
---

<BaseLayout
    title="Instant Fence Quote Calculator | Ghareeb Fencing Solutions"
    description="Get an instant ballpark fence quote in 60 seconds. Draw on a map or enter measurements. See pricing for cedar, vinyl, chain link & more."
    canonical="/quote/ballpark/"
>
    <!-- Hidden Netlify Form for backup lead capture (no JS needed) -->
    <form name="ballpark-leads" netlify netlify-honeypot="bot-field" hidden>
        <input type="text" name="bot-field" />
        <input type="text" name="name" />
        <input type="tel" name="phone" />
        <input type="email" name="email" />
        <input type="text" name="address" />
        <input type="text" name="fenceStyle" />
        <input type="text" name="linearFeet" />
        <input type="text" name="height" />
        <input type="text" name="gates" />
        <input type="text" name="estimatedRange" />
        <textarea name="notes"></textarea>
    </form>

    <section class="hero-mini">
        <div class="container">
            <div class="breadcrumb">
                <a href="/">Home</a> / <a href="/quote/">Quote</a> / <span>Ballpark Calculator</span>
            </div>
            <h1>Instant Ballpark Quote</h1>
            <p class="subtitle">Get a price estimate in 60 seconds — just tell us about your project</p>
        </div>
    </section>

    <section class="calculator-section">
        <div class="container">
            <div class="calculator-grid">
                <div class="calculator-main">

                    <!-- ========== STEP 1: LEAD WALL (FIRST) ========== -->
                    <div class="calc-step" id="step-1">
                        <div class="step-header">
                            <span class="step-number">1</span>
                            <div><h3>Tell us about yourself</h3><p>Enter your info to unlock the instant quote tool</p></div>
                        </div>
                        <div id="lead-wall-form">
                            <div style="position:absolute;left:-9999px;top:-9999px;" aria-hidden="true"><input type="text" name="website" id="hp-website" tabindex="-1" autocomplete="off" /></div>
                            <div class="form-row">
                                <div class="form-group"><label for="lead-name">Full Name *</label><input type="text" id="lead-name" required placeholder="John Smith" /></div>
                                <div class="form-group"><label for="lead-phone">Phone *</label><input type="tel" id="lead-phone" required placeholder="(419) 555-1234" /></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group"><label for="lead-email">Email</label><input type="email" id="lead-email" placeholder="john@email.com" /></div>
                                <div class="form-group"><label for="lead-address">Property Address *</label><input type="text" id="lead-address" required placeholder="123 Main St, Toledo, OH" /></div>
                            </div>
                            <button type="button" id="unlock-tool-btn" class="btn btn-primary btn-block btn-lg" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                                Unlock Quote Tool
                            </button>
                            <p class="form-disclaimer">Your info is never shared. We'll follow up within 24 hours with a detailed estimate.</p>
                        </div>
                        <!-- Success state after unlock -->
                        <div id="lead-wall-success" style="display: none;">
                            <div class="success-banner">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                <div><strong>Quote tool unlocked!</strong><span>Now configure your fence below to see instant pricing.</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- ========== STEP 2: LOCATION / MAP (locked until Step 1 done) ========== -->
                    <div class="calc-step locked-step" id="step-2">
                        <div class="step-header">
                            <span class="step-number">2</span>
                            <div><h3>Measure your fence line</h3><p>Draw on the map or enter measurements manually</p></div>
                        </div>
                        <div class="locked-overlay" id="step-2-lock">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="32" height="32"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                            <span>Complete Step 1 to unlock</span>
                        </div>
                        <div class="step-content" id="step-2-content" style="display:none;">
                            <div class="address-search">
                                <input type="text" id="address-input" placeholder="Search a different address (or we'll use the one above)" />
                                <button type="button" id="search-btn" class="btn btn-primary">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg> Search
                                </button>
                            </div>
                            <div id="map-container">
                                <div id="map"></div>
                                <div class="map-instructions" id="map-instructions">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                    <span>Click "Search" to load your property on satellite view</span>
                                </div>
                            </div>
                            <div class="map-toolbar" id="map-toolbar" style="display: none;">
                                <button type="button" id="draw-btn" class="toolbar-btn active">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>
                                    Draw Fence Line
                                </button>
                                <button type="button" id="clear-btn" class="toolbar-btn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg> Clear
                                </button>
                                <div class="toolbar-info"><strong>Total Length:</strong> <span id="total-length">0</span> ft</div>
                            </div>
                            <div class="manual-entry">
                                <button type="button" id="manual-toggle" class="text-btn">Or enter measurements manually</button>
                                <div id="manual-inputs" style="display: none;">
                                    <label><span>Linear Feet of Fence</span>
                                        <input type="number" id="manual-feet" min="20" max="2000" placeholder="e.g., 150" />
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ========== STEP 3: FENCE TYPE (locked until Step 1 done) ========== -->
                    <div class="calc-step locked-step" id="step-3">
                        <div class="step-header">
                            <span class="step-number">3</span>
                            <div><h3>Choose your fence style</h3><p>Select a material and style</p></div>
                        </div>
                        <div class="locked-overlay" id="step-3-lock">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="32" height="32"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                            <span>Complete Step 1 to unlock</span>
                        </div>
                        <div class="step-content" id="step-3-content" style="display:none;">
                            <div id="fence-styles-loading" class="loading-state"><div class="spinner"></div><span>Loading fence styles...</span></div>
                            <div id="fence-styles-grid" class="fence-styles-grid" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- ========== STEP 4: OPTIONS (locked until Step 1 done) ========== -->
                    <div class="calc-step locked-step" id="step-4">
                        <div class="step-header">
                            <span class="step-number">4</span>
                            <div><h3>Customize your project</h3><p>Select height and additional options</p></div>
                        </div>
                        <div class="locked-overlay" id="step-4-lock">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="32" height="32"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                            <span>Complete Step 1 to unlock</span>
                        </div>
                        <div class="step-content" id="step-4-content" style="display:none;">
                            <div class="options-grid">
                                <div class="option-group">
                                    <label for="fence-height">Fence Height</label>
                                    <select id="fence-height"><option value="4">4 ft</option><option value="5">5 ft</option><option value="6" selected>6 ft (Standard)</option><option value="8">8 ft</option></select>
                                </div>
                                <div class="option-group">
                                    <label for="single-gates">Single Gates (Walk)</label>
                                    <select id="single-gates"><option value="0">None</option><option value="1" selected>1 Gate</option><option value="2">2 Gates</option><option value="3">3 Gates</option></select>
                                </div>
                                <div class="option-group">
                                    <label for="double-gates">Double Gates (Drive)</label>
                                    <select id="double-gates"><option value="0" selected>None</option><option value="1">1 Gate</option><option value="2">2 Gates</option></select>
                                </div>
                                <div class="checkbox-group">
                                    <label class="checkbox-label"><input type="checkbox" id="remove-old" /><span>Remove existing fence (+$4/ft)</span></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== SIDEBAR: QUOTE SUMMARY ========== -->
                <div class="calculator-sidebar">
                    <div class="quote-summary">
                        <h3><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><rect x="2" y="3" width="20" height="18" rx="2"/><path d="M16 3v4M8 3v4M2 11h20"/></svg> Your Quote</h3>

                        <!-- LOCKED state -->
                        <div id="quote-locked">
                            <div class="summary-placeholder" id="summary-placeholder">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="40" height="40"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                                <p>Complete steps 1-4 to see your instant quote</p>
                            </div>
                            <div id="summary-preview" style="display: none;">
                                <div class="summary-line"><span>Style</span><span id="preview-style">—</span></div>
                                <div class="summary-line"><span>Length</span><span id="preview-feet">—</span></div>
                                <div class="summary-line"><span>Height</span><span id="preview-height">—</span></div>
                                <div class="summary-line"><span>Gates</span><span id="preview-gates">—</span></div>
                                <div id="preview-removal-line" class="summary-line" style="display:none;"><span>Old Fence Removal</span><span>Yes</span></div>
                                <hr>
                                <div class="estimate-range">
                                    <div class="range-label">Your Estimated Price</div>
                                    <div class="range-values">
                                        <span class="range-low" id="range-low">$0</span>
                                        <span class="range-separator">—</span>
                                        <span class="range-high" id="range-high">$0</span>
                                    </div>
                                </div>
                                <p class="estimate-note">*Final price determined after free on-site measurement</p>
                                <div class="summary-actions">
                                    <a href={`tel:${site.company.phoneRaw}`} class="btn btn-primary btn-block">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
                                        Call to Schedule — {site.company.phone}
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="trust-badges">
                        <div class="badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg><span>3-Year Warranty</span></div>
                        <div class="badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg><span>4.9★ Rating</span></div>
                        <div class="badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg><span>0% Financing</span></div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</BaseLayout>

<script is:inline define:vars={{ mapsApiKey }}>
    if (mapsApiKey && mapsApiKey !== 'undefined' && mapsApiKey !== '') {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${mapsApiKey}&libraries=drawing,places,geometry&callback=initGoogleMaps`;
        script.async = true; script.defer = true;
        script.onerror = function() { window._mapsUnavailable = true; showManualFallback(); };
        document.head.appendChild(script);
        window.initGoogleMaps = function() {
            if (window._toolUnlocked && window._leadAddress) {
                searchAddress(window._leadAddress);
            }
        };
    } else {
        window._mapsUnavailable = true;
        document.addEventListener('DOMContentLoaded', function() { showManualFallback(); });
    }
    function showManualFallback() {
        var mc = document.getElementById('map-container');
        var mi = document.getElementById('manual-inputs');
        var mt = document.getElementById('manual-toggle');
        var ins = document.getElementById('map-instructions');
        if (mc) mc.style.display = 'none';
        if (document.getElementById('address-input')) document.getElementById('address-input').parentElement.style.display = 'none';
        if (mi) mi.style.display = 'block';
        if (mt) mt.style.display = 'none';
        if (document.getElementById('map-toolbar')) document.getElementById('map-toolbar').style.display = 'none';
    }
</script>

<script is:inline src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script is:inline src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<script is:inline define:vars={{ firebaseConfig }}>
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let map = null, drawingManager = null, polylines = [], totalFeet = 0, selectedStyle = null, pricingData = [];
const heightMultipliers = { '4': 0.85, '5': 0.92, '6': 1.0, '8': 1.25 };
const removalCostPerFoot = 4;
window._toolUnlocked = false;
window._leadAddress = '';

const $ = id => document.getElementById(id);

// ===========================
// PRICING — synced from settings/global (same source as Executive App)
// Format: "Style Name : pricePerFoot : singleGatePrice : doubleGatePrice"
// ===========================
async function loadPricing() {
    try {
        const doc = await db.collection('settings').doc('global').get();
        if (doc.exists && doc.data().pricing) {
            const lines = doc.data().pricing.split('\n').filter(l => l.trim());
            pricingData = lines.map(l => {
                const p = l.split(':').map(s => s.trim());
                return { name: p[0]||'Unknown', pricePerFoot: parseFloat(p[1])||0, singleGate: parseFloat(p[2])||350, doubleGate: parseFloat(p[3])||650 };
            }).filter(i => i.pricePerFoot > 0);
        }
    } catch(e) { console.error('Pricing load error:', e); }
    // Fallback defaults if Firestore has no pricing
    if (!pricingData.length) {
        pricingData = [
            { name:'Cedar Privacy', pricePerFoot:42, singleGate:375, doubleGate:695 },
            { name:'Treated Wood Privacy', pricePerFoot:35, singleGate:325, doubleGate:595 },
            { name:'White Vinyl Privacy', pricePerFoot:45, singleGate:425, doubleGate:795 },
            { name:'Tan Vinyl Privacy', pricePerFoot:47, singleGate:425, doubleGate:795 },
            { name:'Black Chain Link', pricePerFoot:22, singleGate:275, doubleGate:495 },
            { name:'Galvanized Chain Link', pricePerFoot:18, singleGate:250, doubleGate:450 },
            { name:'Black Aluminum', pricePerFoot:48, singleGate:450, doubleGate:850 },
            { name:'Bronze Aluminum', pricePerFoot:50, singleGate:475, doubleGate:895 }
        ];
    }
    renderFenceStyles();
}

function renderFenceStyles() {
    $('fence-styles-loading').style.display = 'none';
    $('fence-styles-grid').style.display = 'grid';
    $('fence-styles-grid').innerHTML = pricingData.map((s, i) => `<button type="button" class="fence-style-card" data-index="${i}"><div class="style-name">${s.name}</div><div class="style-price">from $${s.pricePerFoot}/ft</div></button>`).join('');
    document.querySelectorAll('.fence-style-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.fence-style-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedStyle = pricingData[parseInt(card.dataset.index)];
            updateQuote();
        });
    });
}

// ===========================
// QUOTE CALCULATION — live updates
// ===========================
function getFeet() { return $('manual-feet') && $('manual-feet').value ? parseInt($('manual-feet').value) : totalFeet; }

function updateQuote() {
    const feet = getFeet();
    if (feet < 20 || !selectedStyle) { $('summary-placeholder').style.display = 'flex'; $('summary-preview').style.display = 'none'; return; }
    $('summary-placeholder').style.display = 'none';
    $('summary-preview').style.display = 'block';
    $('preview-style').textContent = selectedStyle.name;
    $('preview-feet').textContent = feet + ' ft';
    $('preview-height').textContent = $('fence-height').value + ' ft';
    let g = [];
    if (parseInt($('single-gates').value) > 0) g.push(parseInt($('single-gates').value) + ' single');
    if (parseInt($('double-gates').value) > 0) g.push(parseInt($('double-gates').value) + ' double');
    $('preview-gates').textContent = g.length ? g.join(', ') : 'None';
    $('preview-removal-line').style.display = $('remove-old').checked ? 'flex' : 'none';

    // Calculate price
    const hm = heightMultipliers[$('fence-height').value];
    const sg = parseInt($('single-gates').value), dg = parseInt($('double-gates').value);
    const rem = $('remove-old').checked;
    const total = (feet * selectedStyle.pricePerFoot * hm) + (sg * selectedStyle.singleGate) + (dg * selectedStyle.doubleGate) + (rem ? feet * removalCostPerFoot : 0);
    const lo = Math.round(total * 0.85), hi = Math.round(total * 1.15);
    $('range-low').textContent = '$' + lo.toLocaleString();
    $('range-high').textContent = '$' + hi.toLocaleString();
}

// ===========================
// STEP 1: LEAD WALL — unlock tool
// ===========================
function checkLeadReady() {
    const ready = $('lead-name').value.trim() && $('lead-phone').value.trim() && $('lead-address').value.trim();
    $('unlock-tool-btn').disabled = !ready;
}
['lead-name','lead-phone','lead-email','lead-address'].forEach(id => $(id).addEventListener('input', checkLeadReady));

$('unlock-tool-btn').addEventListener('click', async () => {
    const name = $('lead-name').value.trim();
    const phone = $('lead-phone').value.trim();
    const email = $('lead-email').value.trim();
    const address = $('lead-address').value.trim();

    if (!name || !phone || !address) return;

    const btn = $('unlock-tool-btn');
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px;display:inline-block;"></div> Unlocking...';

    try {
        // Save lead via server API → goes to Firestore jobs collection
        const res = await fetch('/api/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: 'lead',
                name, phone, email, address,
                notes: 'Started ballpark quote tool',
                website: $('hp-website')?.value || ''
            })
        });

        // Also submit to Netlify Forms as backup
        try {
            const netlifyForm = new FormData();
            netlifyForm.append('form-name', 'ballpark-leads');
            netlifyForm.append('name', name);
            netlifyForm.append('phone', phone);
            netlifyForm.append('email', email);
            netlifyForm.append('address', address);
            fetch('/', { method: 'POST', body: netlifyForm }).catch(() => {});
        } catch(e) {}

    } catch(e) {
        console.error('Lead save error:', e);
        // Don't block the tool — still unlock even if save fails
    }

    // Unlock the tool
    window._toolUnlocked = true;
    window._leadAddress = address;

    // Show success, hide form
    $('lead-wall-form').style.display = 'none';
    $('lead-wall-success').style.display = 'block';

    // Unlock steps 2-4
    document.querySelectorAll('.locked-step').forEach(step => step.classList.remove('locked-step'));
    ['step-2-lock','step-3-lock','step-4-lock'].forEach(id => $(id).style.display = 'none');
    ['step-2-content','step-3-content','step-4-content'].forEach(id => $(id).style.display = 'block');

    // Pre-fill address search and auto-geocode
    $('address-input').value = address;
    if (window.google && window.google.maps) {
        searchAddress(address);
    }

    // Scroll to step 2
    $('step-2').scrollIntoView({ behavior: 'smooth', block: 'start' });
});

// ===========================
// STEP 2: MAP / DRAWING
// ===========================
function initMap(lat, lng) {
    $('map-instructions').style.display = 'none';
    $('map-toolbar').style.display = 'flex';
    map = new google.maps.Map($('map'), { center:{lat,lng}, zoom:20, mapTypeId:'satellite', tilt:0, disableDefaultUI:true, zoomControl:true });
    drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: google.maps.drawing.OverlayType.POLYLINE, drawingControl: false,
        polylineOptions: { strokeColor:'#d4af37', strokeWeight:4, clickable:true, editable:true }
    });
    drawingManager.setMap(map);
    google.maps.event.addListener(drawingManager, 'polylinecomplete', pl => {
        polylines.push(pl); calcLength();
        google.maps.event.addListener(pl.getPath(), 'set_at', calcLength);
        google.maps.event.addListener(pl.getPath(), 'insert_at', calcLength);
    });
}

function calcLength() {
    totalFeet = 0;
    polylines.forEach(pl => {
        const path = pl.getPath();
        for (let i = 0; i < path.getLength() - 1; i++) {
            totalFeet += google.maps.geometry.spherical.computeDistanceBetween(path.getAt(i), path.getAt(i+1)) * 3.28084;
        }
    });
    totalFeet = Math.round(totalFeet);
    $('total-length').textContent = totalFeet;
    updateQuote();
}

function searchAddress(addr) {
    if (!addr) addr = $('address-input').value.trim();
    if (!addr) return;
    new google.maps.Geocoder().geocode({ address: addr }, (r, s) => {
        if (s === 'OK' && r[0]) { const loc = r[0].geometry.location; initMap(loc.lat(), loc.lng()); }
        else { $('map-instructions').innerHTML = '<span>Could not find that address. Try drawing manually or enter feet below.</span>'; }
    });
}
window.searchAddress = searchAddress;
$('search-btn').addEventListener('click', () => searchAddress());
$('address-input').addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); searchAddress(); } });

// Manual entry
$('manual-toggle').addEventListener('click', () => {
    const mi = $('manual-inputs');
    mi.style.display = mi.style.display === 'none' ? 'block' : 'none';
    $('manual-toggle').textContent = mi.style.display === 'none' ? 'Or enter measurements manually' : 'Hide manual entry';
});
$('manual-feet').addEventListener('input', () => {
    if ($('manual-feet').value) $('total-length').textContent = $('manual-feet').value;
    updateQuote();
});

// Drawing controls
$('draw-btn').addEventListener('click', () => { if (drawingManager) { drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYLINE); $('draw-btn').classList.add('active'); } });
$('clear-btn').addEventListener('click', () => { polylines.forEach(p => p.setMap(null)); polylines = []; totalFeet = 0; $('total-length').textContent = '0'; updateQuote(); });

// ===========================
// STEP 4: OPTIONS — live update
// ===========================
['fence-height','single-gates','double-gates'].forEach(id => $(id).addEventListener('change', updateQuote));
$('remove-old').addEventListener('change', updateQuote);

// ===========================
// INIT
// ===========================
loadPricing();
</script>

<style>
    .hero-mini { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 120px 0 40px; color: white; }
    .hero-mini .breadcrumb { margin-bottom: 16px; font-size: 0.9rem; }
    .hero-mini .breadcrumb a { color: rgba(255,255,255,0.7); text-decoration: none; }
    .hero-mini .breadcrumb a:hover { color: var(--accent); }
    .hero-mini .breadcrumb span { color: white; }
    .hero-mini h1 { font-size: clamp(2rem, 4vw, 2.5rem); margin-bottom: 8px; }
    .hero-mini .subtitle { color: rgba(255,255,255,0.85); font-size: 1.1rem; }
    .calculator-section { padding: 60px 0; background: var(--bg-light); }
    .calculator-grid { display: grid; grid-template-columns: 1fr 380px; gap: 40px; align-items: start; }
    @media (max-width: 1024px) { .calculator-grid { grid-template-columns: 1fr; } .calculator-sidebar { order: -1; } }
    .calc-step { background: white; border-radius: var(--radius-lg); padding: 32px; margin-bottom: 24px; box-shadow: var(--shadow-sm); position: relative; }
    .locked-step .step-content { display: none; }
    .locked-overlay { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; padding: 40px 20px; color: var(--text-muted); background: #f8fafc; border-radius: var(--radius); text-align: center; }
    .locked-overlay svg { opacity: 0.4; }
    .locked-overlay span { font-size: 0.95rem; }
    .step-header { display: flex; gap: 16px; align-items: flex-start; margin-bottom: 24px; }
    .step-number { width: 36px; height: 36px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0; }
    .step-header h3 { margin: 0 0 4px; font-size: 1.2rem; }
    .step-header p { margin: 0; color: var(--text-muted); font-size: 0.95rem; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 500px) { .form-row { grid-template-columns: 1fr; } }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.95rem; }
    .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: var(--radius); font-size: 1rem; }
    .form-group input:focus, .form-group textarea:focus { border-color: var(--primary); outline: none; }
    .form-disclaimer { font-size: 0.8rem; color: var(--text-muted); text-align: center; margin-top: 12px; }
    .success-banner { display: flex; gap: 16px; align-items: flex-start; background: #ecfdf5; border: 2px solid #10b981; border-radius: var(--radius); padding: 20px; color: #065f46; }
    .success-banner svg { flex-shrink: 0; color: #10b981; margin-top: 2px; }
    .success-banner strong { display: block; margin-bottom: 4px; font-size: 1.1rem; }
    .success-banner span { font-size: 0.95rem; color: #047857; }
    .address-search { display: flex; gap: 12px; margin-bottom: 20px; }
    .address-search input { flex: 1; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: var(--radius); font-size: 1rem; }
    .address-search input:focus { border-color: var(--primary); outline: none; }
    #map-container { position: relative; height: 350px; background: #1a1a2e; border-radius: var(--radius); overflow: hidden; }
    #map { width: 100%; height: 100%; }
    .map-instructions { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; color: rgba(255,255,255,0.7); text-align: center; padding: 20px; }
    .map-toolbar { display: flex; gap: 12px; align-items: center; margin-top: 16px; flex-wrap: wrap; }
    .toolbar-btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; background: white; border: 2px solid #e2e8f0; border-radius: var(--radius); cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
    .toolbar-btn:hover { border-color: var(--primary); }
    .toolbar-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    .toolbar-info { margin-left: auto; padding: 10px 16px; background: var(--accent); color: var(--primary-dark); border-radius: var(--radius); font-weight: 600; }
    .manual-entry { margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0; }
    .text-btn { background: none; border: none; color: var(--primary); cursor: pointer; text-decoration: underline; font-size: 0.95rem; }
    #manual-inputs { margin-top: 16px; }
    #manual-inputs label { display: block; }
    #manual-inputs span { display: block; margin-bottom: 8px; font-weight: 500; }
    #manual-inputs input { width: 100%; max-width: 200px; padding: 12px; border: 2px solid #e2e8f0; border-radius: var(--radius); font-size: 1rem; }
    .loading-state { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 40px; color: var(--text-muted); }
    .spinner { width: 24px; height: 24px; border: 3px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .fence-styles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
    .fence-style-card { padding: 20px 16px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: var(--radius); cursor: pointer; text-align: center; transition: all 0.2s; }
    .fence-style-card:hover { border-color: var(--primary); background: white; }
    .fence-style-card.selected { border-color: var(--accent); background: white; box-shadow: 0 0 0 3px rgba(212,175,55,0.2); }
    .style-name { font-weight: 600; color: var(--text); }
    .style-price { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }
    .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
    .option-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.95rem; }
    .option-group select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: var(--radius); font-size: 1rem; background: white; cursor: pointer; }
    .checkbox-group { grid-column: 1 / -1; }
    .checkbox-label { display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .checkbox-label input { width: 20px; height: 20px; cursor: pointer; }
    .calculator-sidebar { position: sticky; top: 100px; }
    .quote-summary { background: white; border-radius: var(--radius-lg); padding: 28px; box-shadow: var(--shadow-md); }
    .quote-summary h3 { margin: 0 0 20px; font-size: 1.3rem; display: flex; align-items: center; gap: 10px; }
    .summary-placeholder { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 30px 20px; color: var(--text-muted); }
    .summary-placeholder svg { margin-bottom: 12px; opacity: 0.5; }
    .summary-line { display: flex; justify-content: space-between; padding: 8px 0; font-size: 0.95rem; }
    .summary-line span:first-child { color: var(--text-muted); }
    #summary-preview hr { margin: 16px 0; border: none; border-top: 1px solid #e2e8f0; }
    .estimate-range { text-align: center; padding: 20px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: var(--radius); color: white; }
    .range-label { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; margin-bottom: 8px; }
    .range-values { font-size: 1.8rem; font-weight: 700; }
    .range-separator { margin: 0 8px; opacity: 0.5; }
    .estimate-note { font-size: 0.8rem; color: var(--text-muted); text-align: center; margin-top: 12px; margin-bottom: 0; }
    .summary-actions { margin-top: 24px; display: flex; flex-direction: column; gap: 12px; }
    .btn-block { width: 100%; justify-content: center; }
    .btn-lg { padding: 14px 24px; font-size: 1.05rem; }
    .trust-badges { display: flex; justify-content: center; gap: 16px; margin-top: 20px; flex-wrap: wrap; }
    .trust-badges .badge { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: var(--text-muted); }
</style>
