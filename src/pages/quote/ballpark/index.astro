---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getSiteSettings } from '../../../lib/firestore.js';
const site = await getSiteSettings();
const firebaseConfig = {
  apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY,
  authDomain: import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.PUBLIC_FIREBASE_APP_ID
};
const mapsApiKey = import.meta.env.PUBLIC_GOOGLE_MAPS_KEY || '';
---

<BaseLayout title="Instant Fence Quote Calculator | Ghareeb Fencing Solutions" description="Get an instant ballpark fence quote in 60 seconds. Draw fence lines, add gates, and see pricing instantly." canonical="/quote/ballpark/">
    <form name="ballpark-leads" netlify netlify-honeypot="bot-field" hidden>
        <input type="text" name="bot-field" /><input type="text" name="name" /><input type="tel" name="phone" />
        <input type="email" name="email" /><input type="text" name="address" /><input type="text" name="fenceStyle" />
        <input type="text" name="linearFeet" /><input type="text" name="height" /><input type="text" name="gates" />
        <input type="text" name="removal" /><input type="text" name="estimatedRange" /><textarea name="notes"></textarea>
    </form>

    <section class="hero-mini"><div class="container">
        <div class="breadcrumb"><a href="/">Home</a> / <a href="/quote/">Quote</a> / <span>Ballpark Calculator</span></div>
        <h1>Instant Ballpark Quote</h1>
        <p class="subtitle">Get a price estimate in 60 seconds ‚Äî just tell us about your project</p>
    </div></section>

    <section class="calculator-section"><div class="container"><div class="calculator-grid">
        <div class="calculator-main">

            <!-- STEP 1: LEAD CAPTURE -->
            <div class="calc-step" id="step-1">
                <div class="step-header"><span class="step-number">1</span><div><h3>Tell us about yourself</h3><p>Enter your info to unlock the instant quote tool</p></div></div>
                <div id="lead-wall-form">
                    <div style="position:absolute;left:-9999px;" aria-hidden="true"><input type="text" name="website" id="hp-website" tabindex="-1" autocomplete="off" /></div>
                    <div class="form-row">
                        <div class="form-group"><label for="lead-name">Full Name *</label><input type="text" id="lead-name" required placeholder="John Smith" /></div>
                        <div class="form-group"><label for="lead-phone">Phone *</label><input type="tel" id="lead-phone" required placeholder="(419) 555-1234" /></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="lead-email">Email</label><input type="email" id="lead-email" placeholder="john@email.com" /></div>
                        <div class="form-group"><label for="lead-address">Property Address *</label><input type="text" id="lead-address" required placeholder="123 Main St, Toledo, OH" /></div>
                    </div>
                    <button type="button" id="unlock-tool-btn" class="btn btn-primary btn-block btn-lg" disabled>üîì Unlock Quote Tool</button>
                    <p class="form-disclaimer">Your info is never shared. We'll follow up within 24 hours with a detailed estimate.</p>
                </div>
                <div id="lead-wall-success" style="display:none;">
                    <div class="success-banner">‚úÖ <div><strong>Quote tool unlocked!</strong><span>Now design your fence below to see instant pricing.</span></div></div>
                </div>
            </div>

            <!-- STEP 2: DESIGN YOUR FENCE -->
            <div class="calc-step locked-step" id="step-2">
                <div class="step-header"><span class="step-number">2</span><div><h3>Design your fence</h3><p>Choose a style and draw your fence layout</p></div></div>
                <div class="locked-overlay" id="step-2-lock">üîí <span>Complete Step 1 to unlock</span></div>
                <div class="step-content" id="step-2-content" style="display:none;">

                    <!-- FENCE STYLE DROPDOWN -->
                    <div class="fence-selector">
                        <label class="fence-selector-label">Choose Fence Style:</label>
                        <div class="fence-select-row">
                            <select id="fence-style-dropdown" class="fence-dropdown"></select>
                            <div class="fence-preview-mini" id="fence-preview-mini"></div>
                        </div>
                        <div class="fence-preview-card" id="fence-preview-card" style="display:none;">
                            <img id="fence-preview-img" src="" alt="" class="fence-preview-img" />
                            <div class="fence-preview-info">
                                <span class="fence-preview-name" id="fence-preview-name"></span>
                                <span class="fence-preview-price" id="fence-preview-price"></span>
                            </div>
                        </div>
                    </div>

                    <!-- VIEW TABS -->
                    <div class="view-tabs">
                        <button type="button" class="view-tab active" data-view="grid">üìê Grid Drawing</button>
                        <button type="button" class="view-tab" data-view="map">üó∫Ô∏è Satellite Map</button>
                        <button type="button" class="view-tab" data-view="manual">‚úèÔ∏è Enter Feet</button>
                    </div>

                    <!-- GRID VIEW -->
                    <div class="view-panel active" id="view-grid">
                        <div class="draw-toolbar">
                            <div class="tool-group">
                                <button type="button" class="draw-tool active" data-tool="fence"><span class="tool-icon">‚úèÔ∏è</span><span class="tool-label">Fence</span></button>
                                <button type="button" class="draw-tool" data-tool="gate-walk"><span class="tool-icon">üö™</span><span class="tool-label">Gate</span></button>
                                <button type="button" class="draw-tool" data-tool="gate-drive"><span class="tool-icon">üöó</span><span class="tool-label">Dbl Gate</span></button>
                            </div>
                            <div class="tool-divider"></div>
                            <div class="tool-group">
                                <button type="button" class="draw-tool" data-tool="house"><span class="tool-icon">üè†</span><span class="tool-label">House</span></button>
                                <button type="button" class="draw-tool" data-tool="tree"><span class="tool-icon">üå≥</span><span class="tool-label">Tree</span></button>
                                <button type="button" class="draw-tool" data-tool="text"><span class="tool-icon">üí¨</span><span class="tool-label">Text</span></button>
                            </div>
                            <div class="tool-divider"></div>
                            <button type="button" class="draw-tool" data-tool="erase"><span class="tool-icon">üóë</span><span class="tool-label">Erase</span></button>
                        </div>
                        <div class="grid-wrapper"><canvas id="grid-canvas"></canvas></div>
                        <div class="grid-controls">
                            <button type="button" id="grid-undo" class="toolbar-btn">‚Ü© Undo</button>
                            <button type="button" id="grid-clear" class="toolbar-btn">üóë Clear All</button>
                            <div class="grid-info"><span id="grid-total-display">Total: 0 ft</span></div>
                            <div class="grid-legend"><span>1 sq = 5 ft ¬∑ Double-click to finish line</span></div>
                        </div>
                    </div>

                    <!-- MAP VIEW -->
                    <div class="view-panel" id="view-map">
                        <div class="map-search-bar">
                            <input type="text" id="map-address-input" placeholder="Search your address for satellite view" />
                            <button type="button" id="map-search-btn" class="btn btn-primary btn-sm">üîç Search</button>
                        </div>
                        <div id="map-container"><div id="map"></div><div class="map-instructions" id="map-instructions"><span id="map-status-text">Search your address above to load satellite view</span></div></div>
                        <p class="map-hint">Use satellite view to reference your property, then switch to Grid Drawing to draw fence lines.</p>
                    </div>

                    <!-- MANUAL VIEW -->
                    <div class="view-panel" id="view-manual">
                        <div class="manual-input-group">
                            <p class="panel-hint">Don't worry about being exact ‚Äî this is a ballpark estimate.</p>
                            <label for="manual-feet"><strong>Total Linear Feet of Fence</strong></label>
                            <div class="input-with-unit"><input type="number" id="manual-feet" min="10" max="2000" placeholder="e.g., 150" /><span class="unit">ft</span></div>
                            <div class="footage-helpers">
                                <span class="helper-label">Quick:</span>
                                <button type="button" class="quick-ft" data-ft="50">50 ft</button>
                                <button type="button" class="quick-ft" data-ft="100">100 ft</button>
                                <button type="button" class="quick-ft" data-ft="150">150 ft</button>
                                <button type="button" class="quick-ft" data-ft="200">200 ft</button>
                                <button type="button" class="quick-ft" data-ft="300">300 ft</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STEP 3: OPTIONS -->
            <div class="calc-step locked-step" id="step-3">
                <div class="step-header"><span class="step-number">3</span><div><h3>Project options</h3><p>Height, gates, and extras</p></div></div>
                <div class="locked-overlay" id="step-3-lock">üîí <span>Complete Step 1 to unlock</span></div>
                <div class="step-content" id="step-3-content" style="display:none;">
                    <div class="options-grid">
                        <div class="option-group"><label for="fence-height">Fence Height</label><select id="fence-height"><option value="4">4 ft</option><option value="5">5 ft</option><option value="6" selected>6 ft (Standard)</option><option value="8">8 ft</option></select></div>
                        <div class="checkbox-group"><label class="checkbox-label"><input type="checkbox" id="remove-old" /><span>Remove existing fence (+$4/ft)</span></label></div>
                    </div>
                </div>
            </div>

            <!-- COMPARE STYLES -->
            <div class="calc-step" id="compare-section" style="display:none;">
                <div class="step-header"><span class="step-number">üí°</span><div><h3>Compare fence styles</h3><p>See how different styles affect your estimate</p></div></div>
                <div id="compare-cards"></div>
            </div>
        </div>

        <!-- SIDEBAR -->
        <div class="calculator-sidebar">
            <div class="quote-summary">
                <h3>üìã Your Quote</h3>
                <div id="summary-placeholder" class="summary-placeholder"><p>üîí Complete the steps to see your instant estimate</p></div>
                <div id="summary-preview" style="display:none;">
                    <div id="fence-breakdown"></div>
                    <div id="gate-breakdown"></div>
                    <div id="preview-removal-line" class="summary-line" style="display:none;"><span>üóë Removal</span><span id="removal-cost">+$0</span></div>
                    <div class="summary-line total-line"><span><strong>Total Fence</strong></span><span id="total-feet">0 ft</span></div>
                    <div class="estimate-range">
                        <div class="range-label">Estimated Price Range</div>
                        <div class="range-values"><span id="range-low">$0</span> <span class="range-sep">‚Äî</span> <span id="range-high">$0</span></div>
                    </div>
                    <p class="estimate-note">*Ballpark only. Final price after free on-site measurement.</p>
                    <div class="summary-actions">
                        <a href={`tel:${site.company.phoneRaw}`} class="btn btn-primary btn-block">üìû Call ‚Äî {site.company.phone}</a>
                        <a href="/quote/book/" class="btn btn-outline btn-block">üìÖ Book Free Consultation</a>
                        <button type="button" id="compare-btn" class="btn btn-outline btn-block" style="display:none;">üîÑ Compare Other Styles</button>
                    </div>
                </div>
            </div>
            <div id="drawing-legend" class="drawing-legend" style="display:none;"><h4>üìê Drawing Legend</h4><div id="legend-items"></div></div>
            <div class="trust-badges"><div class="badge">üõ°Ô∏è 3-Year Warranty</div><div class="badge">‚≠ê 4.9‚òÖ Rating</div><div class="badge">üí≥ 0% Financing</div></div>
        </div>
    </div></div></section>

    <!-- TEXT MODAL -->
    <div id="text-modal" class="modal-overlay" style="display:none;"><div class="modal-box">
        <h3>Add Label</h3>
        <input type="text" id="text-modal-input" placeholder="e.g., Neighbor's fence, Slope here..." maxlength="50" />
        <div class="modal-btns"><button type="button" id="text-modal-cancel" class="toolbar-btn">Cancel</button><button type="button" id="text-modal-ok" class="btn btn-primary btn-sm">Add</button></div>
    </div></div>

    <!-- GATE MODAL -->
    <div id="gate-modal" class="modal-overlay" style="display:none;"><div class="modal-box">
        <h3 id="gate-modal-title">Place Gate</h3>
        <p style="color:#64748b;font-size:0.9rem;margin:0 0 16px;">Choose swing direction:</p>
        <div class="gate-direction-btns">
            <button type="button" class="gate-dir-btn" data-dir="left">‚üµ Swings Left</button>
            <button type="button" class="gate-dir-btn" data-dir="right">Swings Right ‚ü∂</button>
        </div>
        <div class="modal-btns"><button type="button" id="gate-modal-cancel" class="toolbar-btn">Cancel</button></div>
    </div></div>
</BaseLayout>

<script is:inline define:vars={{ mapsApiKey }}>
window._mapsApiKey=mapsApiKey||'';
if(mapsApiKey&&mapsApiKey!=='undefined'&&mapsApiKey!==''){
    window.initGoogleMaps=function(){if(window._toolUnlocked&&window._leadAddress)window.searchMapAddress(window._leadAddress);};
}else{window._mapsUnavailable=true;}
</script>
<script is:inline src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script is:inline src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<script is:inline define:vars={{ firebaseConfig }}>
(function(){
let db=null;
try{if(firebaseConfig&&firebaseConfig.projectId){if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);db=firebase.firestore();}}catch(e){}
const $=id=>document.getElementById(id);
const HM={'4':0.85,'5':0.92,'6':1.0,'8':1.25};
window._toolUnlocked=false;window._leadAddress='';
let leadData={},leadDocId=null;

/* ======== PRICING ======== */
let pricingData=[];
const DEF=[
    {name:'Cedar Privacy',ppf:42,sg:375,dg:695,color:'#c0813d',img:''},
    {name:'Treated Wood',ppf:35,sg:325,dg:595,color:'#8B7355',img:''},
    {name:'White Vinyl',ppf:45,sg:425,dg:795,color:'#e8e8e8',img:''},
    {name:'Tan Vinyl',ppf:47,sg:425,dg:795,color:'#d4c5a0',img:''},
    {name:'Vinyl Picket',ppf:32,sg:350,dg:650,color:'#f0f0f0',img:''},
    {name:'Black Chain Link',ppf:22,sg:275,dg:495,color:'#333',img:''},
    {name:'Galv. Chain Link',ppf:18,sg:250,dg:450,color:'#999',img:''},
    {name:'Black Aluminum',ppf:48,sg:450,dg:850,color:'#1a1a2e',img:''},
    {name:'Bronze Aluminum',ppf:50,sg:475,dg:895,color:'#7B5B3A',img:''},
    {name:'Split Rail',ppf:16,sg:200,dg:400,color:'#A0784C',img:''},
    {name:'Ranch Rail',ppf:28,sg:300,dg:550,color:'#6B4226',img:''}
];
let selFence=null;

async function loadPricing(){
    if(db){try{
        const d=await db.collection('settings').doc('global').get();
        if(d.exists){const data=d.data();
            if(data.pricing){let i=0;pricingData=data.pricing.split('\n').filter(l=>l.trim()).map(l=>{const p=l.split(':').map(s=>s.trim());const df=DEF[i]||{color:'#666',img:''};i++;return{name:p[0]||'Unknown',ppf:parseFloat(p[1])||0,sg:parseFloat(p[2])||350,dg:parseFloat(p[3])||650,color:df.color,img:''};}).filter(x=>x.ppf>0);}
            if(data.fenceStyles){try{const styles=typeof data.fenceStyles==='string'?JSON.parse(data.fenceStyles):data.fenceStyles;if(Array.isArray(styles)){styles.forEach(s=>{const match=pricingData.find(p=>p.name.toLowerCase().includes(s.name?.toLowerCase())||s.name?.toLowerCase().includes(p.name?.toLowerCase()));if(match&&s.image)match.img=s.image;if(match&&s.color)match.color=s.color;});}}catch(e){}}
        }
        try{const snap=await db.collection('fenceStyles').get();snap.forEach(doc=>{const s=doc.data();const match=pricingData.find(p=>p.name.toLowerCase()===s.name?.toLowerCase());if(match){if(s.image||s.imageUrl)match.img=s.image||s.imageUrl;if(s.color)match.color=s.color;}});}catch(e){}
    }catch(e){}}
    if(!pricingData.length)pricingData=[...DEF];
    selFence=pricingData[0];renderDropdown();
}

function renderDropdown(){
    const dd=$('fence-style-dropdown');if(!dd)return;
    dd.innerHTML=pricingData.map((s,i)=>`<option value="${i}">${s.name}</option>`).join('');
    dd.addEventListener('change',()=>{selFence=pricingData[+dd.value];showPreview(selFence);updateQ();});
    showPreview(selFence);
}
function showPreview(f){
    const card=$('fence-preview-card'),img=$('fence-preview-img'),name=$('fence-preview-name'),price=$('fence-preview-price'),mini=$('fence-preview-mini');
    if(mini)mini.innerHTML=`<span class="swatch-lg" style="background:${f.color}"></span>`;
    if(f.img){card.style.display='flex';img.src=f.img;img.alt=f.name;name.textContent=f.name;price.textContent='~$'+f.ppf+'/ft installed';}else{card.style.display='none';}
}

/* ======== VIEW TABS ======== */
document.querySelectorAll('.view-tab').forEach(tab=>{tab.addEventListener('click',()=>{
    document.querySelectorAll('.view-tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.view-panel').forEach(p=>p.classList.remove('active'));
    tab.classList.add('active');const panel=$('view-'+tab.dataset.view);if(panel)panel.classList.add('active');
    if(tab.dataset.view==='grid')initCanvas();
    if(tab.dataset.view==='map'&&window._leadAddress&&$('map-address-input'))$('map-address-input').value=window._leadAddress;
});});

/* ======== DRAWING STATE ======== */
let canvas,ctx,GCS=20,GS=5;
let tool='fence',objs=[],cfp=[],dragS=null,undo=[];

function initCanvas(){
    canvas=$('grid-canvas');if(!canvas)return;
    if(canvas._init)return;
    const wrapper=canvas.parentElement;
    const w=Math.min(wrapper.clientWidth,800);
    const h=Math.round(w*0.6);
    const dpr=window.devicePixelRatio||1;
    canvas.width=w*dpr;canvas.height=h*dpr;
    canvas.style.width=w+'px';canvas.style.height=h+'px';
    ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
    GCS=Math.max(14,Math.floor(w/40));
    canvas._init=true;canvas._w=w;canvas._h=h;
    canvas.addEventListener('click',onClick);canvas.addEventListener('mousemove',onMove);
    canvas.addEventListener('mousedown',onDown);canvas.addEventListener('mouseup',onUp);
    canvas.addEventListener('dblclick',onDbl);
    canvas.addEventListener('contextmenu',e=>{e.preventDefault();finFence();});
    canvas.addEventListener('touchstart',onTS,{passive:false});canvas.addEventListener('touchmove',onTM,{passive:false});canvas.addEventListener('touchend',onTE,{passive:false});
    redraw();
}
function gcp(e){const r=canvas.getBoundingClientRect();return{x:(e.clientX-r.left)*(canvas._w/r.width),y:(e.clientY-r.top)*(canvas._h/r.height)};}
function sn(v){return Math.round(v/GCS)*GCS;}
function di(a,b){return Math.sqrt((a.x-b.x)**2+(a.y-b.y)**2);}
function fd(a,b){const dx=Math.abs(b.x-a.x)/GCS,dy=Math.abs(b.y-a.y)/GCS;return Math.round(Math.sqrt(dx*dx+dy*dy)*GS);}

/* ======== TOUCH ======== */
let lastTap=0;
function tp(e){const r=canvas.getBoundingClientRect();const t=e.touches[0]||e.changedTouches[0];return{x:(t.clientX-r.left)*(canvas._w/r.width),y:(t.clientY-r.top)*(canvas._h/r.height)};}
function onTS(e){e.preventDefault();if(tool==='house'){const p=tp(e);dragS={x:sn(p.x),y:sn(p.y)};}}
function onTM(e){e.preventDefault();const p=tp(e);const sx=sn(p.x),sy=sn(p.y);redraw();
    if(tool==='fence'&&cfp.length>0)drawPL(cfp[cfp.length-1],{x:sx,y:sy});
    if(tool==='house'&&dragS)drawPR(dragS,{x:sx,y:sy});
}
function onTE(e){e.preventDefault();const p=tp(e);const sx=sn(p.x),sy=sn(p.y);const now=Date.now();
    if(now-lastTap<300&&tool==='fence'&&cfp.length>=2){finFence();lastTap=0;return;}
    lastTap=now;
    if(tool==='house'&&dragS){const w=Math.abs(sx-dragS.x),h=Math.abs(sy-dragS.y);
        if(w>=GCS&&h>=GCS){su();const lb=prompt('Label (House, Garage, Shed):')||'House';objs.push({type:'house',x:Math.min(dragS.x,sx),y:Math.min(dragS.y,sy),w,h,label:lb});redraw();updateQ();asd();}dragS=null;return;}
    doClick(sx,sy);
}

/* ======== GATE MODAL ======== */
let pendingGate=null;
function openGM(x,y,type){pendingGate={x,y,type};$('gate-modal-title').textContent=type==='gate-walk'?'Place Walk Gate':'Place Double Gate';$('gate-modal').style.display='flex';}
document.querySelectorAll('.gate-dir-btn').forEach(b=>{b.addEventListener('click',()=>{if(!pendingGate)return;su();objs.push({type:pendingGate.type,x:pendingGate.x,y:pendingGate.y,dir:b.dataset.dir});$('gate-modal').style.display='none';pendingGate=null;redraw();updateQ();asd();});});
$('gate-modal-cancel').addEventListener('click',()=>{$('gate-modal').style.display='none';pendingGate=null;});

function doClick(x,y){
    if(tool==='fence'){cfp.push({x,y});redraw();return;}
    if(tool==='gate-walk'||tool==='gate-drive'){openGM(x,y,tool);return;}
    if(tool==='tree'){su();objs.push({type:'tree',x,y});redraw();asd();return;}
    if(tool==='text'){openTM(x,y);return;}
    if(tool==='erase'){const o=findAt(x,y);if(o){su();objs.splice(objs.indexOf(o),1);redraw();updateQ();asd();}return;}
}

/* ======== TOOLS ======== */
document.querySelectorAll('.draw-tool').forEach(btn=>{btn.addEventListener('click',()=>{finFence();document.querySelectorAll('.draw-tool').forEach(b=>b.classList.remove('active'));btn.classList.add('active');tool=btn.dataset.tool;});});

/* ======== MOUSE ======== */
function onClick(e){const p=gcp(e);doClick(sn(p.x),sn(p.y));}
function onDown(e){if(tool==='house'){const p=gcp(e);dragS={x:sn(p.x),y:sn(p.y)};}}
function onUp(e){if(tool==='house'&&dragS){const p=gcp(e);const ex=sn(p.x),ey=sn(p.y);const w=Math.abs(ex-dragS.x),h=Math.abs(ey-dragS.y);
    if(w>=GCS&&h>=GCS){su();const lb=prompt('Label (House, Garage, Shed):')||'House';objs.push({type:'house',x:Math.min(dragS.x,ex),y:Math.min(dragS.y,ey),w,h,label:lb});redraw();asd();}dragS=null;}}
function onMove(e){const p=gcp(e);const mx=p.x,my=p.y;const sx=sn(mx),sy=sn(my);redraw();
    if(tool==='fence'&&cfp.length>0){drawPL(cfp[cfp.length-1],{x:sx,y:sy});drawSP(sx,sy,'rgba(212,175,55,0.5)');}
    if(tool==='house'&&dragS)drawPR(dragS,{x:sx,y:sy});
    if(tool==='gate-walk'||tool==='gate-drive')drawSP(sx,sy,'rgba(16,185,129,0.5)');
    if(tool==='tree'){ctx.beginPath();ctx.arc(sx,sy,GCS*0.8,0,Math.PI*2);ctx.fillStyle='rgba(34,139,34,0.3)';ctx.fill();}
    if(tool==='erase')canvas.style.cursor=findAt(mx,my)?'pointer':'crosshair';
}
function onDbl(e){
    const p=gcp(e);const o=findAt(p.x,p.y);
    if(o&&(o.type==='gate-walk'||o.type==='gate-drive')){o.dir=o.dir==='left'?'right':'left';redraw();asd();e.stopPropagation();return;}
    if(tool==='fence'&&cfp.length>=2)finFence();
}

function drawPL(from,to){ctx.beginPath();ctx.moveTo(from.x,from.y);ctx.lineTo(to.x,to.y);ctx.strokeStyle='rgba(212,175,55,0.5)';ctx.lineWidth=2;ctx.setLineDash([5,5]);ctx.stroke();ctx.setLineDash([]);
    const d=fd(from,to);if(d>0){ctx.font='bold 12px sans-serif';ctx.fillStyle='#d4af37';ctx.fillText(d+'ft',(from.x+to.x)/2+5,(from.y+to.y)/2-8);}}
function drawPR(from,to){const sx=sn(to.x),sy=sn(to.y);const w=Math.abs(sx-from.x),h=Math.abs(sy-from.y);ctx.fillStyle='rgba(100,130,180,0.3)';ctx.strokeStyle='#4682B4';ctx.lineWidth=2;
    ctx.fillRect(Math.min(from.x,sx),Math.min(from.y,sy),w,h);ctx.strokeRect(Math.min(from.x,sx),Math.min(from.y,sy),w,h);
    ctx.font='11px sans-serif';ctx.fillStyle='#4682B4';ctx.fillText(Math.round(w/GCS*GS)+'√ó'+Math.round(h/GCS*GS)+'ft',Math.min(from.x,sx)+4,Math.min(from.y,sy)-4);}

function finFence(){if(cfp.length>=2){su();const segs=[];for(let i=0;i<cfp.length-1;i++)segs.push({dist:fd(cfp[i],cfp[i+1])});objs.push({type:'fence',points:[...cfp],fenceType:{...selFence},segments:segs});updateQ();asd();}cfp=[];redraw();}

function findAt(mx,my){for(let i=objs.length-1;i>=0;i--){const o=objs[i];
    if(o.type==='fence'){for(let j=0;j<o.points.length-1;j++){if(dts(mx,my,o.points[j],o.points[j+1])<10)return o;}}
    if(o.type==='gate-walk'||o.type==='gate-drive'){if(di({x:mx,y:my},o)<GCS*1.2)return o;}
    if(o.type==='tree'){if(di({x:mx,y:my},o)<GCS)return o;}
    if(o.type==='house'){if(mx>=o.x&&mx<=o.x+o.w&&my>=o.y&&my<=o.y+o.h)return o;}
    if(o.type==='text'){if(mx>=o.x-5&&mx<=o.x+100&&my>=o.y-15&&my<=o.y+5)return o;}}return null;}
function dts(px,py,a,b){const dx=b.x-a.x,dy=b.y-a.y,l2=dx*dx+dy*dy;if(l2===0)return di({x:px,y:py},a);let t=((px-a.x)*dx+(py-a.y)*dy)/l2;t=Math.max(0,Math.min(1,t));return di({x:px,y:py},{x:a.x+t*dx,y:a.y+t*dy});}

/* ======== RENDER ======== */
function drawGrid(){const w=canvas._w,h=canvas._h;ctx.fillStyle='#f8fafc';ctx.fillRect(0,0,w,h);ctx.strokeStyle='#e8ecf0';ctx.lineWidth=0.5;
    for(let x=0;x<=w;x+=GCS){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();}
    for(let y=0;y<=h;y+=GCS){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}
    ctx.font='10px sans-serif';ctx.fillStyle='#b0b8c4';ctx.fillText('1 sq = '+GS+' ft',4,h-4);}
function drawSP(x,y,c){ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.fillStyle=c;ctx.fill();}

function redraw(){if(!ctx)return;drawGrid();
    objs.forEach(o=>{if(o.type==='house')drawHouse(o);});
    objs.forEach(o=>{if(o.type==='fence')drawFL(o);});
    objs.forEach(o=>{
        if(o.type==='gate-walk')drawGate(o,'Walk Gate','#10b981',GCS*0.7);
        if(o.type==='gate-drive')drawGate(o,'Dbl Gate','#3b82f6',GCS*1.0);
        if(o.type==='tree')drawTr(o);if(o.type==='text')drawTx(o);});
    if(cfp.length>0){ctx.beginPath();ctx.moveTo(cfp[0].x,cfp[0].y);for(let i=1;i<cfp.length;i++)ctx.lineTo(cfp[i].x,cfp[i].y);ctx.strokeStyle=selFence?.color||'#d4af37';ctx.lineWidth=4;ctx.stroke();
        cfp.forEach((p,i)=>drawSP(p.x,p.y,i===0?'#10b981':selFence?.color||'#d4af37'));
        for(let i=0;i<cfp.length-1;i++){const a=cfp[i],b=cfp[i+1];ctx.font='bold 10px sans-serif';ctx.fillStyle='#1e3a5f';ctx.fillText(fd(a,b)+'ft',(a.x+b.x)/2+4,(a.y+b.y)/2-6);}}
    let tf=0;objs.forEach(o=>{if(o.type==='fence')o.segments.forEach(s=>tf+=s.dist);});
    const gd=$('grid-total-display');if(gd)gd.textContent='Total: '+tf+' ft';
}

function drawFL(o){if(o.points.length<2)return;ctx.beginPath();ctx.moveTo(o.points[0].x,o.points[0].y);for(let i=1;i<o.points.length;i++)ctx.lineTo(o.points[i].x,o.points[i].y);ctx.strokeStyle=o.fenceType.color;ctx.lineWidth=4;ctx.stroke();
    if(o.fenceType.name.includes('Chain')){ctx.setLineDash([6,4]);ctx.strokeStyle='rgba(255,255,255,0.4)';ctx.lineWidth=2;ctx.stroke();ctx.setLineDash([]);}
    o.points.forEach(p=>drawSP(p.x,p.y,o.fenceType.color));
    for(let i=0;i<o.points.length-1;i++){const a=o.points[i],b=o.points[i+1];ctx.font='bold 10px sans-serif';ctx.fillStyle='#1e3a5f';ctx.fillText(o.segments[i].dist+'ft',(a.x+b.x)/2+4,(a.y+b.y)/2-6);}
    const m={x:(o.points[0].x+o.points[1].x)/2,y:(o.points[0].y+o.points[1].y)/2};ctx.font='9px sans-serif';ctx.fillStyle='rgba(30,58,95,0.7)';ctx.fillText(o.fenceType.name,m.x+4,m.y+14);}

/* ======== ARCHITECTURAL GATES ======== */
function drawGate(o,label,color,radius){
    const dir=o.dir||'right';const gw=radius*2;
    ctx.strokeStyle=color;ctx.lineWidth=2;
    /* Gate posts */
    ctx.beginPath();ctx.moveTo(o.x-radius,o.y-6);ctx.lineTo(o.x-radius,o.y+6);ctx.stroke();
    ctx.beginPath();ctx.moveTo(o.x+radius,o.y-6);ctx.lineTo(o.x+radius,o.y+6);ctx.stroke();
    /* Gate panel */
    ctx.fillStyle=color+'22';ctx.strokeStyle=color;ctx.lineWidth=1.5;
    ctx.fillRect(o.x-radius,o.y-2,gw,4);ctx.strokeRect(o.x-radius,o.y-2,gw,4);
    /* Swing arc */
    ctx.setLineDash([4,4]);ctx.strokeStyle=color+'66';ctx.lineWidth=1;
    if(dir==='right'){
        ctx.beginPath();ctx.arc(o.x-radius,o.y,gw,0,-Math.PI/2,true);ctx.stroke();
        ctx.beginPath();ctx.arc(o.x-radius,o.y,3,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();
    }else{
        ctx.beginPath();ctx.arc(o.x+radius,o.y,gw,-Math.PI,-Math.PI/2,false);ctx.stroke();
        ctx.beginPath();ctx.arc(o.x+radius,o.y,3,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();
    }
    ctx.setLineDash([]);
    /* Labels */
    ctx.font='bold 9px sans-serif';ctx.fillStyle=color;ctx.textAlign='center';
    ctx.fillText(label,o.x,o.y+radius+14);
    ctx.font='7px sans-serif';ctx.fillStyle=color+'88';ctx.fillText('dbl-click to flip',o.x,o.y+radius+23);
    ctx.textAlign='left';
}

function drawTr(o){ctx.beginPath();ctx.arc(o.x,o.y,GCS*0.8,0,Math.PI*2);ctx.fillStyle='rgba(34,139,34,0.35)';ctx.fill();ctx.strokeStyle='#228B22';ctx.lineWidth=1.5;ctx.stroke();ctx.beginPath();ctx.arc(o.x,o.y,3,0,Math.PI*2);ctx.fillStyle='#5C4033';ctx.fill();}
function drawHouse(o){ctx.fillStyle='rgba(70,100,140,0.15)';ctx.fillRect(o.x,o.y,o.w,o.h);ctx.strokeStyle='#4682B4';ctx.lineWidth=2;ctx.strokeRect(o.x,o.y,o.w,o.h);
    ctx.strokeStyle='rgba(70,130,180,0.2)';ctx.lineWidth=1;for(let d=-o.h;d<o.w;d+=GCS){ctx.beginPath();ctx.moveTo(Math.max(o.x,o.x+d),d<0?o.y-d+o.y:o.y);ctx.lineTo(Math.min(o.x+o.w,o.x+d+o.h),d+o.h<o.w?o.y+o.h:o.y+o.w-d);ctx.stroke();}
    ctx.font='bold 11px sans-serif';ctx.fillStyle='#4682B4';ctx.textAlign='center';ctx.fillText(o.label||'House',o.x+o.w/2,o.y+o.h/2+4);ctx.textAlign='left';
    ctx.font='9px sans-serif';ctx.fillStyle='rgba(70,130,180,0.6)';ctx.fillText(Math.round(o.w/GCS*GS)+'√ó'+Math.round(o.h/GCS*GS)+'ft',o.x+4,o.y+14);}
function drawTx(o){ctx.font='bold 12px sans-serif';ctx.fillStyle='#6b21a8';ctx.fillText(o.text,o.x,o.y);ctx.beginPath();ctx.arc(o.x-4,o.y-4,2,0,Math.PI*2);ctx.fillStyle='#6b21a8';ctx.fill();}

/* ======== TEXT MODAL ======== */
let tPos=null;
function openTM(x,y){tPos={x,y};$('text-modal').style.display='flex';$('text-modal-input').value='';$('text-modal-input').focus();}
$('text-modal-cancel').addEventListener('click',()=>{$('text-modal').style.display='none';tPos=null;});
$('text-modal-ok').addEventListener('click',()=>{const t=$('text-modal-input').value.trim();if(t&&tPos){su();objs.push({type:'text',x:tPos.x,y:tPos.y,text:t});redraw();asd();}$('text-modal').style.display='none';tPos=null;});
$('text-modal-input').addEventListener('keypress',e=>{if(e.key==='Enter')$('text-modal-ok').click();});

/* ======== UNDO ======== */
function su(){undo.push(JSON.stringify(objs));}
$('grid-undo').addEventListener('click',()=>{if(cfp.length>0){cfp.pop();redraw();return;}if(undo.length){objs=JSON.parse(undo.pop());redraw();updateQ();asd();}});
$('grid-clear').addEventListener('click',()=>{if(!confirm('Clear entire drawing?'))return;su();objs=[];cfp=[];redraw();updateQ();asd();});

/* ======== QUOTE CALC ======== */
function updateQ(){
    const fences={},gates={walk:0,drive:0};let totalFt=0;
    objs.forEach(o=>{if(o.type==='fence'){const ft=o.segments.reduce((s,g)=>s+g.dist,0);const k=o.fenceType.name;if(!fences[k])fences[k]={ft:0,ppf:o.fenceType.ppf,sg:o.fenceType.sg,dg:o.fenceType.dg,color:o.fenceType.color};fences[k].ft+=ft;totalFt+=ft;}
        if(o.type==='gate-walk')gates.walk++;if(o.type==='gate-drive')gates.drive++;});
    const mf=$('manual-feet')&&$('manual-feet').value?parseInt($('manual-feet').value):0;if(mf>0&&!totalFt)totalFt=mf;
    if(totalFt<10&&!Object.keys(fences).length){$('summary-placeholder').style.display='flex';$('summary-preview').style.display='none';$('drawing-legend').style.display='none';$('compare-btn').style.display='none';$('compare-section').style.display='none';return;}
    $('summary-placeholder').style.display='none';$('summary-preview').style.display='block';$('compare-btn').style.display='block';
    const hm=HM[$('fence-height').value];const rem=$('remove-old').checked;let gt=0,bh='';
    if(Object.keys(fences).length>0){for(const[n,f]of Object.entries(fences)){gt+=f.ft*f.ppf*hm;bh+=`<div class="summary-line"><span><span class="swatch" style="background:${f.color}"></span>${n}</span><span>${f.ft} ft</span></div>`;}}
    else if(mf>0&&selFence){gt=mf*selFence.ppf*hm;bh=`<div class="summary-line"><span><span class="swatch" style="background:${selFence.color}"></span>${selFence.name}</span><span>${mf} ft</span></div>`;}
    $('fence-breakdown').innerHTML=bh;
    let gh='';
    if(gates.walk>0){const ff=Object.values(fences)[0]||selFence||pricingData[0];const c=gates.walk*(ff.sg||350);gt+=c;gh+=`<div class="summary-line"><span>üö™ Walk Gates √ó${gates.walk}</span><span>$${c.toLocaleString()}</span></div>`;}
    if(gates.drive>0){const ff=Object.values(fences)[0]||selFence||pricingData[0];const c=gates.drive*(ff.dg||650);gt+=c;gh+=`<div class="summary-line"><span>üöó Drive Gates √ó${gates.drive}</span><span>$${c.toLocaleString()}</span></div>`;}
    $('gate-breakdown').innerHTML=gh;
    if(rem&&totalFt>0){const rc=totalFt*4;gt+=rc;$('preview-removal-line').style.display='flex';$('removal-cost').textContent='+$'+rc.toLocaleString();}else $('preview-removal-line').style.display='none';
    $('total-feet').innerHTML='<strong>'+totalFt+' ft</strong>';
    const lo=Math.round(gt*0.85),hi=Math.round(gt*1.15);
    $('range-low').textContent='$'+lo.toLocaleString();$('range-high').textContent='$'+hi.toLocaleString();
    leadData.estimate={low:lo,high:hi,totalFt,fences,gates,height:$('fence-height').value,removal:rem};
    updateLeg(fences,gates);
    if(lo>0&&leadData.name){clearTimeout(window._qst);window._qst=setTimeout(()=>submitLead(leadData,'Ballpark: '+Object.keys(fences).join(', ')+', '+totalFt+'ft, $'+lo+'-$'+hi),3000);}
}

/* ======== COMPARE ======== */
$('compare-btn').addEventListener('click',()=>{const s=$('compare-section');s.style.display=s.style.display==='none'?'block':'none';if(s.style.display==='block'){renderCompare();s.scrollIntoView({behavior:'smooth',block:'start'});}});
function renderCompare(){
    let tf=0;objs.forEach(o=>{if(o.type==='fence')o.segments.forEach(s=>tf+=s.dist);});
    const mf=$('manual-feet')&&$('manual-feet').value?parseInt($('manual-feet').value):0;if(mf>0&&!tf)tf=mf;if(tf<10)tf=150;
    const hm=HM[$('fence-height').value];
    let h='<div class="compare-grid">';
    pricingData.forEach((s,idx)=>{const cost=Math.round(tf*s.ppf*hm);const lo=Math.round(cost*0.85),hi=Math.round(cost*1.15);const isSel=selFence&&selFence.name===s.name;
        h+=`<div class="compare-card${isSel?' compare-active':''}">`;
        h+=`<div class="compare-color" style="background:${s.color}"></div>`;
        if(s.img)h+=`<img src="${s.img}" alt="${s.name}" class="compare-img" />`;
        h+=`<div class="compare-name">${s.name}</div><div class="compare-price">$${lo.toLocaleString()} ‚Äî $${hi.toLocaleString()}</div>`;
        h+=`<div class="compare-ppf">~$${s.ppf}/ft ¬∑ ${tf}ft</div>`;
        if(!isSel)h+=`<button class="compare-select-btn" onclick="document.getElementById('fence-style-dropdown').value='${idx}';document.getElementById('fence-style-dropdown').dispatchEvent(new Event('change'));document.getElementById('compare-section').style.display='none';">Select</button>`;
        else h+=`<span class="compare-current">‚úì Selected</span>`;
        h+=`</div>`;});
    h+='</div>';$('compare-cards').innerHTML=h;
}

function updateLeg(fences,gates){const leg=$('drawing-legend'),items=$('legend-items');const has=objs.length>0;leg.style.display=has?'block':'none';if(!has)return;
    let h='';for(const[n,f]of Object.entries(fences))h+=`<div class="legend-row"><span class="swatch" style="background:${f.color}"></span><span>${n}: ${f.ft}ft</span></div>`;
    if(gates.walk>0)h+=`<div class="legend-row">üö™ Walk Gates: ${gates.walk}</div>`;if(gates.drive>0)h+=`<div class="legend-row">üöó Drive Gates: ${gates.drive}</div>`;
    objs.filter(o=>o.type==='house').forEach(x=>{h+=`<div class="legend-row">üè† ${x.label}</div>`;});
    const tr=objs.filter(o=>o.type==='tree').length;if(tr)h+=`<div class="legend-row">üå≥ Trees: ${tr}</div>`;items.innerHTML=h;}

/* ======== SAVE DRAWING ======== */
let svT=null;function asd(){clearTimeout(svT);svT=setTimeout(()=>saveDraw(),2000);}
async function saveDraw(){if(!db||!leadDocId)return;try{const dd=objs.map(o=>o.type==='fence'?{type:o.type,points:o.points,fenceTypeName:o.fenceType.name,fenceTypeColor:o.fenceType.color,segments:o.segments}:{...o});
    const img=canvas.toDataURL('image/png',0.7);await db.collection('jobs').doc(leadDocId).update({drawing:JSON.stringify(dd),drawingImage:img,drawingUpdatedAt:firebase.firestore.FieldValue.serverTimestamp()});}catch(e){}}

/* ======== LEAD SUBMIT ‚Äî jobs + websiteLeads + Netlify Forms + API ======== */
async function submitLead(d,notes){
    try{const f=new FormData();f.append('form-name','ballpark-leads');f.append('name',d.name||'');f.append('phone',d.phone||'');f.append('email',d.email||'');f.append('address',d.address||'');if(d.estimate)f.append('estimatedRange','$'+d.estimate.low+'-$'+d.estimate.high);f.append('notes',notes||'');await fetch('/__forms.html',{method:'POST',body:f});}catch(e){}
    if(db&&!leadDocId){try{const ref=await db.collection('jobs').add({cName:d.name,cPhone:d.phone,cEmail:d.email||'',cAddress:d.address,status:'Lead',source:'website-ballpark',priority:'normal',style:d.estimate?.fences?Object.keys(d.estimate.fences).join(', '):(selFence?.name||''),height:(d.estimate?.height||'6')+' ft',footage:String(d.estimate?.totalFt||0),singleGates:d.estimate?.gates?.walk||0,doubleGates:d.estimate?.gates?.drive||0,estimateLow:d.estimate?.low||0,estimateHigh:d.estimate?.high||0,estimatedRange:d.estimate?'$'+d.estimate.low+'-$'+d.estimate.high:'',notes:(notes||'')+'\n[Website Ballpark ‚Äî '+new Date().toLocaleDateString()+']',createdAt:firebase.firestore.FieldValue.serverTimestamp(),updatedAt:firebase.firestore.FieldValue.serverTimestamp(),cDate:new Date().toISOString().split('T')[0],websiteLead:true,isWebsiteLead:true});leadDocId=ref.id;}catch(e){}}
    if(db){try{const np=(d.name||'').split(' ');await db.collection('websiteLeads').add({firstName:np[0]||'',lastName:np.slice(1).join(' ')||'',name:d.name,phone:d.phone,email:d.email||'',address:d.address,source:'ballpark-calculator',fenceType:d.estimate?.fences?Object.keys(d.estimate.fences).join(', '):(selFence?.name||''),totalFeet:d.estimate?.totalFt||0,estimateLow:d.estimate?.low||0,estimateHigh:d.estimate?.high||0,estimatedRange:d.estimate?'$'+d.estimate.low+'-$'+d.estimate.high:'',notes:notes||'',createdAt:firebase.firestore.FieldValue.serverTimestamp(),status:'new',jobId:leadDocId||''});}catch(e){}}
    try{await fetch('/api/submit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'lead',name:d.name,phone:d.phone,email:d.email,address:d.address,fenceType:selFence?.name||'',fenceLength:d.estimate?.totalFt||0,fenceHeight:d.estimate?.height||'6',singleGates:d.estimate?.gates?.walk||0,doubleGates:d.estimate?.gates?.drive||0,estimateLow:d.estimate?.low||0,estimateHigh:d.estimate?.high||0,estimatedRange:d.estimate?'$'+d.estimate.low+'-$'+d.estimate.high:'',notes:notes||'',website:$('hp-website')?.value||''})});}catch(e){}
}

/* ======== STEP 1 UNLOCK ======== */
function checkR(){$('unlock-tool-btn').disabled=!($('lead-name').value.trim()&&$('lead-phone').value.trim()&&$('lead-address').value.trim());}
['lead-name','lead-phone','lead-email','lead-address'].forEach(id=>{const el=$(id);if(el)el.addEventListener('input',checkR);});
$('unlock-tool-btn').addEventListener('click',async()=>{
    const name=$('lead-name').value.trim(),phone=$('lead-phone').value.trim(),email=$('lead-email').value.trim(),address=$('lead-address').value.trim();
    if(!name||!phone||!address)return;
    const btn=$('unlock-tool-btn');btn.disabled=true;btn.textContent='‚è≥ Unlocking...';
    leadData={name,phone,email,address};await submitLead(leadData,'Started property planner');
    window._toolUnlocked=true;window._leadAddress=address;
    $('lead-wall-form').style.display='none';$('lead-wall-success').style.display='block';
    document.querySelectorAll('.locked-step').forEach(s=>s.classList.remove('locked-step'));
    ['step-2-lock','step-3-lock'].forEach(id=>$(id).style.display='none');
    ['step-2-content','step-3-content'].forEach(id=>$(id).style.display='block');
    if($('map-address-input'))$('map-address-input').value=address;
    initCanvas();
    if(!window._mapsUnavailable&&window._mapsApiKey){const s=document.createElement('script');s.src='https://maps.googleapis.com/maps/api/js?key='+window._mapsApiKey+'&libraries=drawing,places,geometry&callback=initGoogleMaps';s.async=true;s.onerror=function(){window._mapsUnavailable=true;$('map-status-text').textContent='Satellite view unavailable';};document.head.appendChild(s);}
    else{$('map-status-text').textContent='Satellite view not configured';}
    $('step-2').scrollIntoView({behavior:'smooth',block:'start'});
});

/* ======== MANUAL + OPTIONS ======== */
if($('manual-feet'))$('manual-feet').addEventListener('input',updateQ);
document.querySelectorAll('.quick-ft').forEach(b=>b.addEventListener('click',()=>{$('manual-feet').value=b.dataset.ft;updateQ();}));
$('fence-height').addEventListener('change',updateQ);
$('remove-old').addEventListener('change',updateQ);

/* ======== MAP ======== */
let gmap=null;
window.searchMapAddress=function(addr){
    if(!addr)addr=$('map-address-input')?.value?.trim();if(!addr){$('map-status-text').textContent='Enter an address to search';return;}
    if(!window.google||!window.google.maps){$('map-status-text').textContent='‚ö†Ô∏è Satellite view requires Maps API setup. Use Grid Drawing to design your fence.';return;}
    $('map-status-text').textContent='üîç Searching...';
    new google.maps.Geocoder().geocode({address:addr},(r,s)=>{
        if(s==='OK'&&r[0]){const loc=r[0].geometry.location;$('map-instructions').style.display='none';gmap=new google.maps.Map($('map'),{center:{lat:loc.lat(),lng:loc.lng()},zoom:20,mapTypeId:'satellite',tilt:0,disableDefaultUI:true,zoomControl:true});}
        else{$('map-status-text').textContent='Address not found ‚Äî try a more specific address.';}});};
if($('map-search-btn'))$('map-search-btn').addEventListener('click',()=>window.searchMapAddress());
if($('map-address-input'))$('map-address-input').addEventListener('keypress',e=>{if(e.key==='Enter'){e.preventDefault();window.searchMapAddress();}});

loadPricing();
})();
</script>

<style>
    .hero-mini{background:linear-gradient(135deg,var(--primary),var(--primary-dark));padding:120px 0 40px;color:white}
    .hero-mini .breadcrumb{margin-bottom:16px;font-size:0.9rem}.hero-mini .breadcrumb a{color:rgba(255,255,255,0.7);text-decoration:none}
    .hero-mini .breadcrumb a:hover{color:var(--accent)}.hero-mini .breadcrumb span{color:white}
    .hero-mini h1{font-size:clamp(2rem,4vw,2.5rem);margin-bottom:8px}.hero-mini .subtitle{color:rgba(255,255,255,0.85);font-size:1.1rem}
    .calculator-section{padding:60px 0;background:var(--bg-light)}
    .calculator-grid{display:grid;grid-template-columns:1fr 380px;gap:40px;align-items:start}
    @media(max-width:1024px){.calculator-grid{grid-template-columns:1fr}.calculator-sidebar{order:-1}}
    .calc-step{background:white;border-radius:12px;padding:32px;margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1);position:relative}
    .locked-step .step-content{display:none}
    .locked-overlay{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:40px 20px;color:#64748b;background:#f8fafc;border-radius:8px;text-align:center;font-size:1.1rem}
    .step-header{display:flex;gap:16px;align-items:flex-start;margin-bottom:24px}
    .step-number{width:36px;height:36px;background:var(--primary,#1e3a5f);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0}
    .step-header h3{margin:0 0 4px;font-size:1.2rem}.step-header p{margin:0;color:#64748b;font-size:0.95rem}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}@media(max-width:500px){.form-row{grid-template-columns:1fr}}
    .form-group{margin-bottom:16px}.form-group label{display:block;margin-bottom:6px;font-weight:500;font-size:0.95rem}
    .form-group input{width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;box-sizing:border-box}
    .form-group input:focus{border-color:var(--primary);outline:none}
    .form-disclaimer{font-size:0.8rem;color:#64748b;text-align:center;margin-top:12px}
    .success-banner{display:flex;gap:16px;align-items:flex-start;background:#ecfdf5;border:2px solid #10b981;border-radius:8px;padding:20px;color:#065f46;font-size:1.1rem}
    .success-banner strong{display:block;margin-bottom:4px}.success-banner span{font-size:0.95rem;color:#047857}
    .fence-selector{margin-bottom:16px;padding:16px;background:#f8fafc;border-radius:10px;border:1px solid #e2e8f0}
    .fence-selector-label{display:block;font-weight:600;margin-bottom:8px;font-size:0.95rem}
    .fence-select-row{display:flex;gap:10px;align-items:center}
    .fence-dropdown{flex:1;padding:10px 14px;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;background:white;cursor:pointer;font-weight:500}
    .fence-dropdown:focus{border-color:var(--primary);outline:none}
    .swatch-lg{width:24px;height:24px;border-radius:6px;border:2px solid rgba(0,0,0,0.15);display:block}
    .fence-preview-card{display:flex;gap:12px;align-items:center;margin-top:12px;padding:10px;background:white;border-radius:8px;border:1px solid #e2e8f0}
    .fence-preview-img{width:80px;height:60px;object-fit:cover;border-radius:6px}
    .fence-preview-info{display:flex;flex-direction:column;gap:2px}
    .fence-preview-name{font-weight:600;font-size:0.95rem}
    .fence-preview-price{color:#64748b;font-size:0.85rem}
    .view-tabs{display:flex;gap:4px;background:#f1f5f9;padding:6px;border-radius:10px 10px 0 0}
    .view-tab{flex:1;padding:10px;border:none;background:transparent;border-radius:6px;cursor:pointer;font-size:0.9rem;font-weight:500;color:#64748b;transition:all 0.15s;text-align:center}
    .view-tab:hover{background:rgba(255,255,255,0.5)}.view-tab.active{background:white;color:var(--primary);font-weight:600;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
    .view-panel{display:none}.view-panel.active{display:block}
    .panel-hint{color:#64748b;font-size:0.9rem;margin:0 0 12px}
    .draw-toolbar{display:flex;gap:6px;align-items:center;flex-wrap:wrap;padding:12px;background:#f1f5f9;border:2px solid #e2e8f0;border-top:none}
    .tool-group{display:flex;gap:4px}.tool-divider{width:1px;height:28px;background:#cbd5e1;margin:0 4px}
    .draw-tool{display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 10px;border:2px solid transparent;border-radius:8px;background:white;cursor:pointer;transition:all 0.15s;min-width:56px}
    .draw-tool:hover{border-color:var(--primary);background:#f0f4ff}
    .draw-tool.active{border-color:var(--primary);background:var(--primary);color:white}
    .draw-tool.active .tool-label{color:white}
    .tool-icon{font-size:1.1rem;line-height:1}.tool-label{font-size:0.65rem;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:0.5px}
    .grid-wrapper{border:2px solid #e2e8f0;border-top:none;overflow:hidden;cursor:crosshair;background:#f8fafc}
    .grid-wrapper canvas{display:block}
    .grid-controls{display:flex;gap:12px;align-items:center;padding:10px 12px;background:#f1f5f9;border:2px solid #e2e8f0;border-top:none;border-radius:0 0 10px 10px;flex-wrap:wrap}
    .grid-info{font-weight:600;font-size:0.9rem;color:var(--primary)}
    .grid-legend{margin-left:auto;font-size:0.8rem;color:#94a3b8}
    .toolbar-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:white;border:1.5px solid #e2e8f0;border-radius:6px;cursor:pointer;font-size:0.85rem;transition:all 0.15s}
    .toolbar-btn:hover{border-color:var(--primary)}
    .map-search-bar{display:flex;gap:10px;padding:12px;background:#f1f5f9;border:2px solid #e2e8f0;border-top:none}
    .map-search-bar input{flex:1;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:0.95rem;background:white}
    .map-search-bar input:focus{border-color:var(--primary);outline:none}
    #map-container{position:relative;height:400px;background:#1a1a2e;border:2px solid #e2e8f0;border-top:none}
    #map{width:100%;height:100%}
    .map-instructions{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.7);text-align:center;padding:20px;font-size:0.95rem}
    .map-hint{font-size:0.85rem;color:#94a3b8;padding:12px;margin:0;background:#f1f5f9;border:2px solid #e2e8f0;border-top:none;border-radius:0 0 10px 10px}
    .manual-input-group{padding:16px;background:white;border:2px solid #e2e8f0;border-top:none;border-radius:0 0 10px 10px}
    .manual-input-group label{display:block;margin-bottom:8px;font-weight:500}
    .input-with-unit{display:flex;align-items:center;max-width:250px}.input-with-unit input{flex:1;padding:12px;border:2px solid #e2e8f0;border-radius:8px 0 0 8px;font-size:1.1rem;border-right:none}
    .input-with-unit input:focus{border-color:var(--primary);outline:none}
    .input-with-unit .unit{padding:12px 14px;background:#f1f5f9;border:2px solid #e2e8f0;border-radius:0 8px 8px 0;font-weight:600;color:#64748b}
    .footage-helpers{margin-top:10px;display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .helper-label{font-size:0.85rem;color:#64748b;font-weight:500}
    .quick-ft{padding:5px 12px;border:1px solid #e2e8f0;border-radius:20px;background:white;cursor:pointer;font-size:0.85rem;transition:all 0.15s}
    .quick-ft:hover{border-color:var(--accent);background:#fffbeb}
    .options-grid{display:flex;gap:20px;align-items:center;flex-wrap:wrap}
    .option-group label{display:block;margin-bottom:6px;font-weight:500;font-size:0.95rem}
    .option-group select{padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;background:white;cursor:pointer}
    .checkbox-group{display:flex;align-items:center}.checkbox-label{display:flex;align-items:center;gap:10px;cursor:pointer}
    .checkbox-label input{width:18px;height:18px;cursor:pointer}
    .calculator-sidebar{position:sticky;top:100px}
    .quote-summary{background:white;border-radius:12px;padding:24px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
    .quote-summary h3{margin:0 0 16px;font-size:1.2rem}
    .summary-placeholder{display:flex;flex-direction:column;align-items:center;text-align:center;padding:24px 16px;color:#64748b}
    .summary-line{display:flex;justify-content:space-between;align-items:center;padding:6px 0;font-size:0.9rem}
    .summary-line span:first-child{color:#475569;display:flex;align-items:center;gap:6px}
    .total-line{padding:10px 0;border-top:1px solid #e2e8f0;margin-top:4px}
    .swatch{width:10px;height:10px;border-radius:50%;flex-shrink:0;display:inline-block;border:1px solid rgba(0,0,0,0.15)}
    .estimate-range{text-align:center;padding:16px;background:linear-gradient(135deg,#1e3a5f,#0f2744);border-radius:8px;color:white;margin-top:8px}
    .range-label{font-size:0.8rem;text-transform:uppercase;letter-spacing:1px;opacity:0.9;margin-bottom:6px}
    .range-values{font-size:1.6rem;font-weight:700}.range-sep{margin:0 6px;opacity:0.5}
    .estimate-note{font-size:0.75rem;color:#64748b;text-align:center;margin-top:10px;margin-bottom:0}
    .summary-actions{margin-top:16px;display:flex;flex-direction:column;gap:8px}
    .btn-block{width:100%;text-align:center}
    .btn-outline{background:white;border:2px solid var(--primary,#1e3a5f);color:var(--primary);padding:10px 16px;border-radius:8px;font-weight:600;text-decoration:none;display:block;transition:all 0.15s;cursor:pointer;font-size:0.95rem}
    .btn-outline:hover{background:var(--primary);color:white}
    .drawing-legend{background:white;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-top:16px}
    .drawing-legend h4{margin:0 0 12px;font-size:1rem}
    .legend-row{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:0.85rem;color:#475569}
    .trust-badges{display:flex;justify-content:center;gap:16px;margin-top:20px;flex-wrap:wrap}
    .trust-badges .badge{font-size:0.85rem;color:#64748b}
    .compare-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .compare-card{background:white;border:2px solid #e2e8f0;border-radius:10px;padding:14px;text-align:center;transition:all 0.15s}
    .compare-card:hover{border-color:var(--primary);box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .compare-active{border-color:var(--accent);background:#fffbeb}
    .compare-color{width:100%;height:6px;border-radius:3px;margin-bottom:8px}
    .compare-img{width:100%;height:70px;object-fit:cover;border-radius:6px;margin-bottom:6px}
    .compare-name{font-weight:600;font-size:0.9rem;margin-bottom:2px}
    .compare-price{font-size:1rem;font-weight:700;color:var(--primary)}
    .compare-ppf{font-size:0.75rem;color:#94a3b8;margin:2px 0 6px}
    .compare-select-btn{padding:5px 12px;border:1.5px solid var(--primary);background:white;color:var(--primary);border-radius:6px;cursor:pointer;font-size:0.8rem;font-weight:500;transition:all 0.15s}
    .compare-select-btn:hover{background:var(--primary);color:white}
    .compare-current{font-size:0.8rem;color:#10b981;font-weight:600}
    .gate-direction-btns{display:flex;gap:10px;margin-bottom:16px}
    .gate-dir-btn{flex:1;padding:14px;border:2px solid #e2e8f0;border-radius:8px;background:white;cursor:pointer;font-size:0.95rem;font-weight:500;transition:all 0.15s;text-align:center}
    .gate-dir-btn:hover{border-color:var(--primary);background:#f0f4ff}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal-box{background:white;border-radius:12px;padding:24px;width:90%;max-width:360px;box-shadow:0 20px 40px rgba(0,0,0,0.2)}
    .modal-box h3{margin:0 0 16px}.modal-box input{width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;box-sizing:border-box}
    .modal-box input:focus{border-color:var(--primary);outline:none}
    .modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
    @media(max-width:600px){.draw-toolbar{gap:3px;padding:8px}.draw-tool{padding:6px 7px;min-width:44px}.tool-icon{font-size:0.95rem}.tool-label{font-size:0.55rem}.tool-divider{height:24px}.grid-legend{display:none}.view-tab{font-size:0.8rem;padding:8px 4px}.compare-grid{grid-template-columns:1fr 1fr}}
</style>
