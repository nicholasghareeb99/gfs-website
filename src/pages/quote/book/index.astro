---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getSiteSettings, getAvailableSlots } from '../../../lib/firestore.js';

const site = await getSiteSettings();
const slots = await getAvailableSlots();
const firebaseConfig = {
  apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY,
  authDomain: import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.PUBLIC_FIREBASE_APP_ID
};
---

<BaseLayout 
    title="Book Free Consultation | Ghareeb Fencing Solutions" 
    description="Schedule a free on-site fence estimate in Toledo & Northwest Ohio. Choose a convenient date and time."
    canonical="/quote/book/"
>
    <section class="hero-mini">
        <div class="container">
            <div class="breadcrumb">
                <a href="/">Home</a> / <a href="/quote/">Quote</a> / <span>Book Consultation</span>
            </div>
            <h1 data-editable data-edit-doc="content/pages" data-edit-field="book.title">Book Your Free Consultation</h1>
            <p class="subtitle" data-editable data-edit-doc="content/pages" data-edit-field="book.subtitle">Schedule a no-obligation on-site estimate at a time that works for you</p>
        </div>
    </section>

    <section class="booking-section">
        <div class="container">
            <div class="booking-grid">
                <!-- Calendar & Time Selection -->
                <div class="booking-main">
                    <div class="booking-step">
                        <div class="step-header">
                            <span class="step-num">1</span>
                            <div><h3>Select a Date</h3><p>Choose your preferred consultation date</p></div>
                        </div>
                        <div class="calendar-wrapper">
                            <div class="calendar-nav">
                                <button type="button" id="cal-prev" class="cal-nav-btn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><polyline points="15 18 9 12 15 6"/></svg>
                                </button>
                                <h4 id="cal-month"></h4>
                                <button type="button" id="cal-next" class="cal-nav-btn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><polyline points="9 18 15 12 9 6"/></svg>
                                </button>
                            </div>
                            <div class="calendar-days">
                                <div class="day-label">Sun</div><div class="day-label">Mon</div><div class="day-label">Tue</div>
                                <div class="day-label">Wed</div><div class="day-label">Thu</div><div class="day-label">Fri</div><div class="day-label">Sat</div>
                            </div>
                            <div class="calendar-grid" id="cal-grid"></div>
                        </div>
                    </div>

                    <div class="booking-step" id="time-step" style="display:none;">
                        <div class="step-header">
                            <span class="step-num">2</span>
                            <div><h3>Pick a Time</h3><p id="selected-date-label">Available times for ‚Äî</p></div>
                        </div>
                        <div class="time-slots" id="time-slots"></div>
                        <div class="no-slots" id="no-slots" style="display:none;">
                            <p>No available times for this date. Please select another date or <a href="/contact/">contact us</a>.</p>
                        </div>
                    </div>

                    <div class="booking-step" id="info-step" style="display:none;">
                        <div class="step-header">
                            <span class="step-num">3</span>
                            <div><h3>Your Information</h3><p>Tell us about you and your project</p></div>
                        </div>
                        <form id="booking-form" novalidate>
                            <div style="position:absolute;left:-9999px;top:-9999px;" aria-hidden="true"><input type="text" name="website" id="hp-website" tabindex="-1" autocomplete="off" /></div>
                            <div class="form-row">
                                <div class="form-group"><label for="book-name">Full Name *</label><input type="text" id="book-name" required placeholder="John Smith" /></div>
                                <div class="form-group"><label for="book-phone">Phone *</label><input type="tel" id="book-phone" required placeholder="(419) 555-1234" /></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group"><label for="book-email">Email *</label><input type="email" id="book-email" required placeholder="john@email.com" /></div>
                                <div class="form-group"><label for="book-address">Property Address *</label><input type="text" id="book-address" required placeholder="123 Main St, Toledo, OH" /></div>
                            </div>
                            <div class="form-group">
                                <label for="book-project">Project Description</label>
                                <select id="book-project">
                                    <option value="">What type of fence are you interested in?</option>
                                    <option value="Cedar Privacy">Cedar Privacy Fence</option>
                                    <option value="Vinyl Privacy">Vinyl Privacy Fence</option>
                                    <option value="Chain Link">Chain Link Fence</option>
                                    <option value="Aluminum Ornamental">Aluminum Ornamental Fence</option>
                                    <option value="Wood Shadowbox">Wood Shadowbox Fence</option>
                                    <option value="Fence Repair">Fence Repair</option>
                                    <option value="Other">Other / Not Sure</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="book-notes">Additional Notes</label>
                                <textarea id="book-notes" rows="3" placeholder="Anything else we should know? (e.g., approx. fence length, pets, specific needs)"></textarea>
                            </div>
                            <button type="submit" id="book-submit" class="btn btn-primary btn-block btn-lg">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                Confirm Booking
                            </button>
                        </form>
                    </div>

                    <div class="booking-step" id="success-step" style="display:none;">
                        <div class="success-card">
                            <div class="success-icon">‚úÖ</div>
                            <h2>Booking Confirmed!</h2>
                            <p class="success-details" id="success-details"></p>
                            <p>We'll call you to confirm within 24 hours. If you need to reschedule, call us at <a href={`tel:${site.company.phoneRaw}`}>{site.company.phone}</a>.</p>
                            <a href="/" class="btn btn-primary">Back to Home</a>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="booking-sidebar">
                    <div class="sidebar-card">
                        <h4>Your Appointment</h4>
                        <div class="appt-summary">
                            <div class="appt-line" id="appt-date"><span>üìÖ Date</span><span>Not selected</span></div>
                            <div class="appt-line" id="appt-time"><span>üïê Time</span><span>Not selected</span></div>
                        </div>
                    </div>
                    <div class="sidebar-card">
                        <h4>What to Expect</h4>
                        <ul class="expect-list">
                            <li>‚úì We come to your property (free)</li>
                            <li>‚úì Professional measurement</li>
                            <li>‚úì Material & style recommendations</li>
                            <li>‚úì Exact written quote</li>
                            <li>‚úì No pressure, no obligation</li>
                        </ul>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 12px;">Typical consultation: 20-30 minutes</p>
                    </div>
                    <div class="sidebar-card" style="background: var(--primary); color: white;">
                        <h4 style="color: var(--accent);">Prefer to Call?</h4>
                        <p style="opacity: 0.9; margin-bottom: 16px;">We're happy to schedule over the phone.</p>
                        <a href={`tel:${site.company.phoneRaw}`} class="btn btn-primary btn-block" style="background: var(--accent); color: var(--primary-dark);">
                            Call {site.company.phone}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>
</BaseLayout>

<script is:inline src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script is:inline src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
<script is:inline define:vars={{ firebaseConfig }}>
(function() {
    const cfg = firebaseConfig;
    if (!firebase.apps.length) firebase.initializeApp(cfg);
    const db = firebase.firestore();

    const $ = id => document.getElementById(id);
    let currentMonth = new Date();
    let selectedDate = null;
    let selectedTime = null;
    let availableSlots = {};

    // Load available slots from Firestore (set by exec app)
    async function loadSlots() {
        try {
            const snap = await db.collection('availableSlots').get();
            snap.forEach(doc => {
                const d = doc.data();
                // Expected format: { date: '2026-02-10', times: ['9:00 AM', '10:00 AM', ...], booked: [] }
                if (d.date) {
                    availableSlots[d.date] = {
                        times: d.times || [],
                        booked: d.booked || []
                    };
                }
            });
        } catch(e) {
            console.log('Slots load error:', e.message);
        }

        // If no slots defined, generate defaults (Mon-Fri, 9-4)
        if (Object.keys(availableSlots).length === 0) {
            const today = new Date();
            for (let i = 1; i <= 30; i++) {
                const d = new Date(today);
                d.setDate(d.getDate() + i);
                if (d.getDay() !== 0 && d.getDay() !== 6) { // Mon-Fri
                    const key = d.toISOString().split('T')[0];
                    availableSlots[key] = {
                        times: ['9:00 AM', '10:00 AM', '11:00 AM', '1:00 PM', '2:00 PM', '3:00 PM', '4:00 PM'],
                        booked: []
                    };
                }
            }
        }
        renderCalendar();
    }

    // Calendar rendering
    function renderCalendar() {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        const today = new Date(); today.setHours(0,0,0,0);

        $('cal-month').textContent = new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        let html = '';
        for (let i = 0; i < firstDay; i++) html += '<div class="cal-day empty"></div>';

        for (let day = 1; day <= daysInMonth; day++) {
            const d = new Date(year, month, day);
            const key = d.toISOString().split('T')[0];
            const slot = availableSlots[key];
            const isPast = d < today;
            const hasSlots = slot && slot.times.filter(t => !(slot.booked || []).includes(t)).length > 0;
            const isSelected = selectedDate === key;

            let cls = 'cal-day';
            if (isPast) cls += ' past';
            else if (hasSlots) cls += ' available';
            else cls += ' unavailable';
            if (isSelected) cls += ' selected';

            html += `<div class="${cls}" data-date="${key}">${day}</div>`;
        }
        $('cal-grid').innerHTML = html;

        // Bind click events
        document.querySelectorAll('.cal-day.available').forEach(el => {
            el.addEventListener('click', () => selectDate(el.dataset.date));
        });
    }

    function selectDate(dateStr) {
        selectedDate = dateStr;
        const d = new Date(dateStr + 'T12:00:00');
        $('selected-date-label').textContent = 'Available times for ' + d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        $('appt-date').querySelector('span:last-child').textContent = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

        // Show available times
        const slot = availableSlots[dateStr];
        const available = slot ? slot.times.filter(t => !(slot.booked || []).includes(t)) : [];

        if (available.length) {
            $('time-slots').innerHTML = available.map(t => `<button type="button" class="time-slot" data-time="${t}">${t}</button>`).join('');
            $('time-slots').style.display = 'grid';
            $('no-slots').style.display = 'none';
            document.querySelectorAll('.time-slot').forEach(btn => {
                btn.addEventListener('click', () => selectTime(btn.dataset.time));
            });
        } else {
            $('time-slots').style.display = 'none';
            $('no-slots').style.display = 'block';
        }

        $('time-step').style.display = 'block';
        selectedTime = null;
        $('appt-time').querySelector('span:last-child').textContent = 'Not selected';
        $('info-step').style.display = 'none';
        renderCalendar();
        $('time-step').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function selectTime(time) {
        selectedTime = time;
        document.querySelectorAll('.time-slot').forEach(b => b.classList.remove('selected'));
        document.querySelector(`.time-slot[data-time="${time}"]`).classList.add('selected');
        $('appt-time').querySelector('span:last-child').textContent = time;
        $('info-step').style.display = 'block';
        $('info-step').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Calendar navigation
    $('cal-prev').addEventListener('click', () => {
        currentMonth.setMonth(currentMonth.getMonth() - 1);
        renderCalendar();
    });
    $('cal-next').addEventListener('click', () => {
        currentMonth.setMonth(currentMonth.getMonth() + 1);
        renderCalendar();
    });

    // Booking form submission
    $('booking-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!selectedDate || !selectedTime) return alert('Please select a date and time.');

        const name = $('book-name').value.trim();
        const phone = $('book-phone').value.trim();
        const email = $('book-email').value.trim();
        const address = $('book-address').value.trim();
        if (!name || !phone || !email || !address) return alert('Please fill in all required fields.');

        const btn = $('book-submit');
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Booking...';

        try {
            // Save via server API (handles Firestore + email notification)
            const res = await fetch('/api/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: 'booking',
                    name, phone, email, address,
                    project: $('book-project').value,
                    notes: $('book-notes').value.trim(),
                    date: selectedDate,
                    time: selectedTime,
                    website: $('hp-website')?.value || ''
                })
            });

            if (!res.ok) throw new Error('Booking failed');

            // Mark time as booked in Firestore (client-side for real-time update)
            try {
                const slotDoc = await db.collection('availableSlots').where('date', '==', selectedDate).get();
                if (!slotDoc.empty) {
                    await slotDoc.docs[0].ref.update({
                        booked: firebase.firestore.FieldValue.arrayUnion(selectedTime)
                    });
                }
            } catch(e) { console.log('Slot update:', e.message); }

            // Show success
            const d = new Date(selectedDate + 'T12:00:00');
            $('success-details').textContent = `${d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })} at ${selectedTime}`;
            $('info-step').style.display = 'none';
            $('time-step').style.display = 'none';
            $('success-step').style.display = 'block';
            $('success-step').scrollIntoView({ behavior: 'smooth', block: 'center' });

        } catch(err) {
            console.error('Booking error:', err);
            alert('Booking failed. Please call us at (419) 902-8257 to schedule.');
            btn.disabled = false;
            btn.innerHTML = 'Confirm Booking';
        }
    });

    loadSlots();
})();
</script>

<style>
    .hero-mini { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 120px 0 40px; color: white; }
    .hero-mini .breadcrumb { margin-bottom: 16px; font-size: 0.9rem; }
    .hero-mini .breadcrumb a { color: rgba(255,255,255,0.7); text-decoration: none; }
    .hero-mini .breadcrumb span { color: white; }
    .hero-mini h1 { font-size: clamp(2rem, 4vw, 2.5rem); margin-bottom: 8px; }
    .hero-mini .subtitle { color: rgba(255,255,255,0.85); font-size: 1.1rem; }
    .booking-section { padding: 60px 0; background: var(--bg-light); }
    .booking-grid { display: grid; grid-template-columns: 1fr 340px; gap: 40px; align-items: start; }
    @media (max-width: 900px) { .booking-grid { grid-template-columns: 1fr; } .booking-sidebar { order: -1; } }
    .booking-step { background: white; border-radius: var(--radius-lg); padding: 32px; margin-bottom: 24px; box-shadow: var(--shadow-sm); }
    .step-header { display: flex; gap: 16px; align-items: flex-start; margin-bottom: 24px; }
    .step-num { width: 36px; height: 36px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0; }
    .step-header h3 { margin: 0 0 4px; font-size: 1.2rem; }
    .step-header p { margin: 0; color: var(--text-muted); font-size: 0.95rem; }

    /* Calendar */
    .calendar-wrapper { max-width: 400px; margin: 0 auto; }
    .calendar-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .calendar-nav h4 { margin: 0; font-size: 1.1rem; }
    .cal-nav-btn { width: 36px; height: 36px; border: 1px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .cal-nav-btn:hover { border-color: var(--primary); }
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 4px; }
    .day-label { text-align: center; font-size: 0.8rem; font-weight: 600; color: var(--text-muted); padding: 8px 0; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .cal-day { text-align: center; padding: 10px; border-radius: 8px; font-size: 0.95rem; cursor: default; }
    .cal-day.empty { visibility: hidden; }
    .cal-day.past { color: #cbd5e1; }
    .cal-day.unavailable { color: #94a3b8; }
    .cal-day.available { background: #f0fdf4; color: #166534; font-weight: 600; cursor: pointer; border: 2px solid transparent; }
    .cal-day.available:hover { border-color: #10b981; }
    .cal-day.selected { background: var(--primary) !important; color: white !important; border-color: var(--primary) !important; }

    /* Time slots */
    .time-slots { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
    .time-slot { padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-size: 0.95rem; font-weight: 600; text-align: center; transition: all 0.2s; }
    .time-slot:hover { border-color: var(--primary); background: #f8fafc; }
    .time-slot.selected { background: var(--primary); color: white; border-color: var(--primary); }
    .no-slots { text-align: center; padding: 20px; color: var(--text-muted); }

    /* Form */
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 500px) { .form-row { grid-template-columns: 1fr; } }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.95rem; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--primary); outline: none; }
    .btn-block { width: 100%; justify-content: center; }
    .btn-lg { padding: 14px 24px; font-size: 1.05rem; }

    /* Success */
    .success-card { text-align: center; padding: 20px 0; }
    .success-icon { font-size: 4rem; margin-bottom: 16px; }
    .success-card h2 { color: #065f46; margin-bottom: 12px; }
    .success-details { font-size: 1.2rem; font-weight: 600; color: var(--primary); margin-bottom: 16px; }

    /* Sidebar */
    .booking-sidebar { position: sticky; top: 100px; }
    .sidebar-card { background: white; border-radius: var(--radius-lg); padding: 24px; margin-bottom: 16px; box-shadow: var(--shadow-sm); }
    .sidebar-card h4 { margin: 0 0 16px; font-size: 1.1rem; }
    .appt-summary { display: flex; flex-direction: column; gap: 12px; }
    .appt-line { display: flex; justify-content: space-between; padding: 10px; background: #f8fafc; border-radius: 6px; font-size: 0.95rem; }
    .expect-list { list-style: none; padding: 0; margin: 0; }
    .expect-list li { padding: 8px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; }
    .expect-list li:last-child { border-bottom: none; }
</style>
