---
import BaseLayout from '../../layouts/BaseLayout.astro';
---
<BaseLayout title="Book Free Consultation | Ghareeb Fencing Solutions Toledo OH" description="Schedule a free on-site fence consultation." pageId="quote-book" activeNav="quote">
<style>
  .calendar{background:white;border:1px solid #e2e8f0;border-radius:12px;padding:25px;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
  .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
  .calendar-title{font-size:1.2rem;font-weight:700;color:#1e293b}
  .cal-nav-btn{background:white;border:1px solid #e2e8f0;color:#1e3a5f;padding:8px 15px;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.15s}
  .cal-nav-btn:hover{border-color:#1e3a5f;background:#f0f4ff}
  .calendar-weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:10px;text-align:center}
  .calendar-weekdays span{padding:10px;font-size:0.8rem;color:#64748b;font-weight:600}
  .calendar-days{display:grid;grid-template-columns:repeat(7,1fr);gap:5px}
  .cal-day{padding:12px;text-align:center;border-radius:8px;cursor:pointer;background:#f8fafc;border:1px solid #e2e8f0;transition:all 0.2s;color:#1e293b;font-weight:500}
  .cal-day:hover:not(.disabled):not(.empty){border-color:var(--accent,#d4af37);background:#fffbeb;color:#1e293b}
  .cal-day.selected{background:var(--accent,#d4af37);color:#0f172a;font-weight:700;border-color:var(--accent,#d4af37)}
  .cal-day.disabled{color:#cbd5e1;cursor:not-allowed;background:#f1f5f9}
  .cal-day.empty{background:transparent;cursor:default;border-color:transparent}
  .cal-day.today{border-color:var(--accent,#d4af37);border-width:2px}
  .time-slots{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:20px}
  .time-slot{padding:12px;text-align:center;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;cursor:pointer;transition:all 0.2s;color:#1e293b;font-weight:500}
  .time-slot:hover{border-color:var(--accent,#d4af37);background:#fffbeb}
  .time-slot.selected{background:var(--accent,#d4af37);color:#0f172a;font-weight:700;border-color:var(--accent,#d4af37)}
  .selected-datetime{background:#ecfdf5;border:2px solid #10b981;border-radius:12px;padding:20px;margin-top:20px;text-align:center;color:#065f46}
  .book-form-group{margin-bottom:16px}
  .book-form-group label{display:block;font-weight:600;margin-bottom:8px;color:#1e293b;font-size:0.9rem}
  .book-form-group input{width:100%;padding:12px 16px;background:white;border:2px solid #e2e8f0;border-radius:8px;color:#1e293b;font-size:1rem;box-sizing:border-box}
  .book-form-group input:focus{outline:none;border-color:var(--primary,#1e3a5f)}
  @media(max-width:900px){.booking-grid{grid-template-columns:1fr!important}}
  @media(max-width:600px){.time-slots{grid-template-columns:repeat(2,1fr)}}
</style>

<section class="section" style="padding-top:140px;">
  <div class="container" style="max-width:900px;">
    <div style="text-align:center;margin-bottom:40px;">
      <div class="section-label" data-editable="book-label">üìÖ Free Consultation</div>
      <h1 class="section-title" data-editable="book-title">Book Your <span class="gold">Appointment</span></h1>
      <p class="section-text" data-editable="book-text">Select a date and time for your free on-site consultation.</p>
    </div>
    <div class="booking-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:30px;">
      <div class="calendar">
        <div class="calendar-header">
          <button class="cal-nav-btn" onclick="prevMonth()">‚Üê Prev</button>
          <span class="calendar-title" id="calTitle"></span>
          <button class="cal-nav-btn" onclick="nextMonth()">Next ‚Üí</button>
        </div>
        <div class="calendar-weekdays"><span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span></div>
        <div class="calendar-days" id="calDays"></div>
        <div id="timeSection" style="display:none;">
          <h4 style="margin:25px 0 15px;color:#1e3a5f;font-weight:700;">Available Times</h4>
          <div class="time-slots" id="timeSlots"></div>
        </div>
      </div>
      <div class="card" style="padding:30px;">
        <h3 style="margin-bottom:20px;" data-editable="book-info-title">Your Information</h3>
        <form id="bookingForm">
          <div class="book-form-group"><label>Name *</label><input type="text" id="bName" required placeholder="John Smith"></div>
          <div class="book-form-group"><label>Phone *</label><input type="tel" id="bPhone" required placeholder="(419) 555-1234"></div>
          <div class="book-form-group"><label>Email *</label><input type="email" id="bEmail" required placeholder="john@example.com"></div>
          <div class="book-form-group"><label>Property Address *</label><input type="text" id="bAddr" required placeholder="123 Main St, Toledo, OH"></div>
          <div class="selected-datetime" id="selDisplay" style="display:none;">
            <p style="font-size:0.9rem;color:#065f46;margin-bottom:5px;">Selected Appointment:</p>
            <p style="font-size:1.2rem;font-weight:700;color:#1e3a5f;" id="selText"></p>
          </div>
          <button type="submit" class="btn btn-primary" style="width:100%;margin-top:20px;" id="bookBtn" disabled>Select a Date & Time</button>
        </form>
      </div>
    </div>
  </div>
</section>

<script is:inline src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script is:inline src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
<script is:inline>
const fbCfg={apiKey:"AIzaSyB6TYNujOLqIt1dzzhBkjsCvVgRt53luRE",authDomain:"ghareeb-fencing.firebaseapp.com",projectId:"ghareeb-fencing",storageBucket:"ghareeb-fencing.firebasestorage.app",messagingSenderId:"187837905206",appId:"1:187837905206:web:1e9a9bc33f745cbeeddb97"};
let db;try{if(!firebase.apps.length)firebase.initializeApp(fbCfg);db=firebase.firestore();}catch(e){}
let curDate=new Date(),selDate=null,selTime=null;

/* Default availability - overridden by Firebase settings/booking */
const DAY_NAMES=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
let availDays=[
    {enabled:false,start:'',end:''},
    {enabled:true,start:'08:00',end:'17:00'},
    {enabled:true,start:'08:00',end:'17:00'},
    {enabled:true,start:'08:00',end:'17:00'},
    {enabled:true,start:'08:00',end:'17:00'},
    {enabled:true,start:'08:00',end:'17:00'},
    {enabled:true,start:'08:00',end:'14:00'}
];
let blockedDates=[];
let existingBookings=[];
let estimateDuration=60;
let maxPerDay=6;

/* Load availability from Firebase */
async function loadAvailability(){
    if(!db)return;
    try{
        const doc=await db.collection('settings').doc('booking').get();
        if(doc.exists){
            const data=doc.data();
            if(data.days&&Array.isArray(data.days))availDays=data.days;
            if(data.blockedDates&&Array.isArray(data.blockedDates))blockedDates=data.blockedDates.map(b=>typeof b==='string'?{date:b}:b);
            if(data.estimateDuration)estimateDuration=data.estimateDuration;
            if(data.maxPerDay)maxPerDay=data.maxPerDay;
        }
        /* Also check settings/global for bookingAvailability (legacy) */
        const gdoc=await db.collection('settings').doc('global').get();
        if(gdoc.exists){
            const gdata=gdoc.data();
            if(gdata.bookingAvailability){
                const ba=typeof gdata.bookingAvailability==='string'?JSON.parse(gdata.bookingAvailability):gdata.bookingAvailability;
                if(ba.days&&Array.isArray(ba.days))availDays=ba.days;
                if(ba.blockedDates&&Array.isArray(ba.blockedDates))blockedDates=ba.blockedDates;
            }
        }
    }catch(e){console.log('Using default availability');}

    /* Load existing bookings to prevent double-booking */
    try{
        const today=new Date().toISOString().split('T')[0];
        const snap=await db.collection('bookings').where('date','>=',today).get();
        snap.forEach(doc=>{const d=doc.data();if(d.date&&d.time&&d.status!=='cancelled')existingBookings.push({date:d.date,time:d.time});});
    }catch(e){}
    renderCal();
}

function generateTimeSlots(dayIdx){
    const day=availDays[dayIdx];
    if(!day||!day.enabled)return[];
    const start=day.start||'08:00';const end=day.end||'17:00';
    const [sh,sm]=start.split(':').map(Number);const [eh,em]=end.split(':').map(Number);
    const slots=[];let h=sh,m=sm;
    while(h<eh||(h===eh&&m<em)){
        const ampm=h>=12?'PM':'AM';const h12=h===0?12:(h>12?h-12:h);
        const mStr=m===0?'00':String(m).padStart(2,'0');
        slots.push(h12+':'+mStr+' '+ampm);
        m+=estimateDuration;if(m>=60){h+=Math.floor(m/60);m=m%60;}
    }
    return slots;
}

function isDateBlocked(dateStr){return blockedDates.some(b=>(typeof b==='string'?b:b.date)===dateStr);}

function getBookingCountForDate(dateStr){return existingBookings.filter(b=>b.date===dateStr).length;}

function isSlotBooked(dateStr,time){return existingBookings.some(b=>b.date===dateStr&&b.time===time);}

function renderCal(){
    const y=curDate.getFullYear(),m=curDate.getMonth(),today=new Date();
    document.getElementById('calTitle').textContent=curDate.toLocaleDateString('en-US',{month:'long',year:'numeric'});
    const fd=new Date(y,m,1).getDay(),dim=new Date(y,m+1,0).getDate();
    let h='';
    for(let i=0;i<fd;i++)h+='<div class="cal-day empty"></div>';
    for(let d=1;d<=dim;d++){
        const dt=new Date(y,m,d);
        const dayIdx=dt.getDay();
        const dateStr=dt.toISOString().split('T')[0];
        const past=dt<new Date(today.getFullYear(),today.getMonth(),today.getDate());
        const dayDisabled=!availDays[dayIdx]||!availDays[dayIdx].enabled;
        const blocked=isDateBlocked(dateStr);
        const full=getBookingCountForDate(dateStr)>=maxPerDay;
        const disabled=past||dayDisabled||blocked||full;
        const isTod=dt.toDateString()===today.toDateString();
        const isSel=selDate&&dt.toDateString()===selDate.toDateString();
        let c='cal-day';
        if(disabled)c+=' disabled';
        if(isTod)c+=' today';
        if(isSel)c+=' selected';
        const oc=disabled?'':`onclick="pickDate(${y},${m},${d})"`;
        let label=''+d;
        if(blocked)label+=' üö´';
        if(full&&!past&&!dayDisabled&&!blocked)label+=' ‚úó';
        h+=`<div class="${c}" ${oc}>${label}</div>`;
    }
    document.getElementById('calDays').innerHTML=h;
}

window.pickDate=function(y,m,d){selDate=new Date(y,m,d);selTime=null;renderCal();showTimes();updateSel();};

function showTimes(){
    if(!selDate){document.getElementById('timeSection').style.display='none';return;}
    document.getElementById('timeSection').style.display='block';
    const dayIdx=selDate.getDay();
    const dateStr=selDate.toISOString().split('T')[0];
    const slots=generateTimeSlots(dayIdx);
    if(slots.length===0){
        document.getElementById('timeSlots').innerHTML='<div style="grid-column:1/-1;text-align:center;color:#64748b;padding:20px;">No available times for this day</div>';
        return;
    }
    let h='';
    slots.forEach(t=>{
        const booked=isSlotBooked(dateStr,t);
        if(booked){
            h+=`<div class="time-slot" style="opacity:0.4;cursor:not-allowed;text-decoration:line-through;" title="Already booked">${t}</div>`;
        }else{
            h+=`<div class="time-slot${selTime===t?' selected':''}" onclick="pickTime('${t}')">${t}</div>`;
        }
    });
    document.getElementById('timeSlots').innerHTML=h;
}

window.pickTime=function(t){selTime=t;showTimes();updateSel();};

function updateSel(){
    const d=document.getElementById('selDisplay'),tx=document.getElementById('selText'),btn=document.getElementById('bookBtn');
    if(selDate&&selTime){
        tx.textContent=selDate.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'})+' at '+selTime;
        d.style.display='block';btn.textContent='Book Appointment ‚Üí';btn.disabled=false;
    }else{d.style.display='none';btn.textContent='Select a Date & Time';btn.disabled=true;}
}

window.prevMonth=function(){curDate.setMonth(curDate.getMonth()-1);renderCal();};
window.nextMonth=function(){curDate.setMonth(curDate.getMonth()+1);renderCal();};

document.getElementById('bookingForm').addEventListener('submit',async function(e){
  e.preventDefault();if(!selDate||!selTime){alert('Please select a date and time');return;}
  const btn=document.getElementById('bookBtn');btn.disabled=true;btn.textContent='‚è≥ Booking...';
  const booking={name:document.getElementById('bName').value.trim(),phone:document.getElementById('bPhone').value.trim(),email:document.getElementById('bEmail').value.trim(),address:document.getElementById('bAddr').value.trim(),date:selDate.toISOString().split('T')[0],time:selTime,source:'website-booking',status:'pending',createdAt:new Date().toISOString()};
  try{
    if(db){
      await db.collection('bookings').add({...booking,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      const np=booking.name.split(' ');
      await db.collection('websiteLeads').add({firstName:np[0]||'',lastName:np.slice(1).join(' ')||'',name:booking.name,phone:booking.phone,email:booking.email,address:booking.address,source:'website-booking',status:'booked',bookingDate:booking.date,bookingTime:booking.time,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      await db.collection('jobs').add({cName:booking.name,cEmail:booking.email,cPhone:booking.phone,cAddress:booking.address,status:'Lead',priority:'normal',source:'Website - Booking',notes:'Appointment: '+booking.date+' at '+booking.time,createdAt:firebase.firestore.FieldValue.serverTimestamp(),updatedAt:firebase.firestore.FieldValue.serverTimestamp(),isWebsiteLead:true,websiteLead:true});
      if(typeof gtag==='function')gtag('event','generate_lead',{event_category:'Conversions',event_label:'Booking',value:100,currency:'USD'});
    }
    document.querySelector('.booking-grid').innerHTML='<div class="card" style="text-align:center;padding:60px 40px;grid-column:1/-1;"><div style="font-size:4rem;margin-bottom:20px;">‚úÖ</div><h2>Appointment <span class="gold">Requested!</span></h2><p style="color:#475569;margin:15px 0 10px;">We\'ve received your booking for:</p><p style="font-size:1.3rem;font-weight:700;color:#1e3a5f;margin-bottom:30px;">'+selDate.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'})+' at '+selTime+'</p><p style="color:#475569;margin-bottom:30px;">We\'ll confirm within 24 hours.</p><a href="/" class="btn btn-primary">Return to Home</a></div>';
  }catch(err){console.error(err);alert('Error. Please call (419) 902-8257.');btn.disabled=false;btn.textContent='Book Appointment ‚Üí';}
});

loadAvailability();
</script>
</BaseLayout>
