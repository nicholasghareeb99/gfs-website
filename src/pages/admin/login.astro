---
import BaseLayout from '../../layouts/BaseLayout.astro';
const firebaseConfig = {
  apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY,
  authDomain: import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.PUBLIC_FIREBASE_APP_ID
};
---

<BaseLayout title="Admin Login" description="Admin login for site editing" noIndex={true}>
  <section style="min-height: 80vh; display: flex; align-items: center; justify-content: center; padding: 40px 20px; background: var(--bg-light);">
    <div class="login-card">
      <div class="login-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="32" height="32"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        <h1>Admin Login</h1>
        <p>Sign in to edit your website</p>
      </div>
      <form id="login-form" novalidate>
        <div class="form-field">
          <label for="email">Email</label>
          <input type="email" id="email" required placeholder="admin@ghareebfencing.com" />
        </div>
        <div class="form-field">
          <label for="password">Password</label>
          <input type="password" id="password" required placeholder="••••••••" />
        </div>
        <div id="login-error" class="login-error" style="display:none;"></div>
        <button type="submit" id="login-btn" class="btn btn-primary btn-block">
          <span class="btn-text">Sign In</span>
          <span class="btn-loading" style="display:none;">Signing in...</span>
        </button>
      </form>
      <div id="logged-in" style="display:none;" class="logged-in-state">
        <div class="success-icon">✅</div>
        <h2>You're logged in!</h2>
        <p>Edit mode is now active on all pages.</p>
        <div class="logged-in-actions">
          <a href="/" class="btn btn-primary">Go to Homepage</a>
          <a href="/admin/" class="btn btn-secondary">Admin Dashboard</a>
          <button id="logout-btn" class="btn btn-ghost">Sign Out</button>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<script is:inline src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script is:inline src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script is:inline define:vars={{ firebaseConfig }}>
(function() {
  const cfg = firebaseConfig;
  if (!firebase.apps.length) firebase.initializeApp(cfg);
  const auth = firebase.auth();

  auth.onAuthStateChanged(u => {
    if (u) {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('logged-in').style.display = 'block';
      document.cookie = 'gfs_admin=1;path=/;max-age=86400;SameSite=Strict;Secure';
    }
  });

  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value;
    const btn = document.getElementById('login-btn');
    const errEl = document.getElementById('login-error');

    btn.querySelector('.btn-text').style.display = 'none';
    btn.querySelector('.btn-loading').style.display = 'inline';
    btn.disabled = true; errEl.style.display = 'none';

    try {
      await auth.signInWithEmailAndPassword(email, pass);
      document.cookie = 'gfs_admin=1;path=/;max-age=86400;SameSite=Strict;Secure';
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('logged-in').style.display = 'block';
    } catch (err) {
      errEl.textContent = err.code === 'auth/wrong-password' ? 'Incorrect password' :
        err.code === 'auth/user-not-found' ? 'Account not found' :
        err.code === 'auth/invalid-email' ? 'Invalid email address' :
        'Login failed: ' + err.message;
      errEl.style.display = 'block';
    }
    btn.querySelector('.btn-text').style.display = 'inline';
    btn.querySelector('.btn-loading').style.display = 'none';
    btn.disabled = false;
  });

  document.getElementById('logout-btn')?.addEventListener('click', () => {
    auth.signOut();
    document.cookie = 'gfs_admin=;path=/;max-age=0;SameSite=Strict;Secure';
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('logged-in').style.display = 'none';
  });
})();
</script>

<style>
  .login-card {
    background: white; border-radius: 16px; padding: 48px; max-width: 440px; width: 100%;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  }
  .login-header { text-align: center; margin-bottom: 32px; }
  .login-header svg { color: var(--primary); margin-bottom: 12px; }
  .login-header h1 { font-size: 1.8rem; margin-bottom: 8px; }
  .login-header p { color: var(--text-muted); }
  .form-field { margin-bottom: 20px; }
  .form-field label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95rem; }
  .form-field input { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s; }
  .form-field input:focus { border-color: var(--primary); outline: none; }
  .login-error { background: #fef2f2; color: #dc2626; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 0.9rem; }
  .btn-block { width: 100%; padding: 14px; font-size: 1.05rem; }
  .logged-in-state { text-align: center; }
  .success-icon { font-size: 3rem; margin-bottom: 16px; }
  .logged-in-state h2 { margin-bottom: 8px; }
  .logged-in-state p { color: var(--text-muted); margin-bottom: 24px; }
  .logged-in-actions { display: flex; flex-direction: column; gap: 12px; }
  .btn-ghost { background: transparent; border: 1px solid #e2e8f0; color: var(--text-muted); padding: 12px; border-radius: 8px; cursor: pointer; }
  .btn-ghost:hover { border-color: var(--primary); color: var(--primary); }
</style>
